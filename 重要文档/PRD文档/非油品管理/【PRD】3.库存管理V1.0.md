### **产品功能说明书 (PRD)**

### **3. 模块：库存管理 (Inventory Management)**

------

#### **3.1 版本修订历史**

| 版本号 | 修订日期   | 修订人   | 修订内容                       |
| ------ | ---------- | -------- | ------------------------------ |
| V1.0   | 2025-06-27 | [孙杨竣] | 初稿，创建库存管理模块核心功能 |

#### **3.2 模块概述**

库存管理模块是连接采购与销售的中央枢纽，其核心职责是实时、准确地追踪和管理公司所有非油商品的物理库存、虚拟库存、在途库存及其相关成本。本模块采用三级库存模型，以支持多场景、多渠道的业务需求，并使用加权平均法进行成本核算，旨在为业务运营提供透明的库存视图，为财务提供精准的成本数据。

#### **3.3 功能范围与目标**

- **目标一：库存模型化** - 建立物理库存、集团库存、渠道库存的三级模型，实现库存分层管理。
- **目标二：库存可视化** - 提供全局、实时的库存查询中心，让库存状况一目了然。
- **目标三：流程可追溯** - 记录所有库存变动流水，确保每一笔库存操作都有据可查。
- **目标四：账实相符** - 通过规范化的盘点流程，定期校准账面库存与实物库存，保障数据准确性。
- **目标五：成本精准化** - 采用加权平均法自动核算库存成本，为毛利分析提供数据支撑。

------

### **4. 核心功能设计**

#### **4.1 核心架构：三级库存模型**

系统库存模型分为三个层级，由底层到上层逐级汇总或映射。

- **第一级：物理库存 (Physical Stock)**
  - **定义：** 指在特定物理位置（如“A加油站”、“中心仓库”）实际存在的、可管理的库存。这是所有库存计算的基础和“真实来源”。
  - **细分状态：**
    - `可售库存`：状态良好，可用于销售或调拨的库存。
    - `在途库存`：在调拨过程中，已从调出仓发货，但尚未被调入仓确认接收的库存。
    - `锁定库存`：已被某个订单（如线上预订单）占用，暂时不可用于其他销售的库存。
    - `冻结/残次库存`：因质量问题、过期等原因不可销售，等待报损或退货的库存。
  - **管理核心：** 系统的所有出入库操作，直接影响物理库存中各个状态的数量。
- **第二级：集团库存 (Group/Central Stock)**
  - **定义：** 一个**逻辑上**的、**只读**的库存视图。它不是一个真实的仓库，而是公司层面某一SKU所有物理库存的总和。
  - **计算规则：** `集团库存(SKU) = Σ (该SKU在所有仓库和油站的物理库存之和)`
  - **应用场景：** 主要为总部采购、运营管理者提供宏观决策支持，例如查看全国总库存以制定集采策略。
- **第三级：渠道/线上库存 (Channel/Online Stock)**
  - **定义：** 一个**虚拟**的库存层，专门用于发布到特定销售渠道（如公司App、小程序、第三方外卖平台）的可售数量。
  - **映射规则：** 渠道库存由物理库存按一定规则映射而来，通常不直接等于物理库存，以防超卖。
  - **示例规则：** A加油站的线上渠道库存 = `A加油站的可售库存` - `安全库存阈值`。
  - **管理功能：**
    - 提供渠道库存的同步规则配置界面。
    - 当物理库存发生变化时，系统自动或定时更新渠道库存。

#### **4.2 实时库存中心 (Real-time Inventory Hub)**

- **功能描述：** 一个功能强大的查询界面，用于查看和分析各层级的库存数据。
- **核心功能：**
  - **多维度查询：** 支持按 `SKU/商品名称/条码`、`商品分类`、`品牌`、`仓库/油站` 等条件进行筛选和查询。
  - **库存视图：** 查询结果清晰展示指定SKU在特定地点的各级、各状态库存，如：
    - 地点：A加油站
    - SKU：某品牌可乐
    - 物理库存：可售(100), 在途(20), 锁定(5), 冻结(2)
    - 渠道库存(App)：90
  - **数据导出：** 支持将查询结果导出为Excel文件。

#### **4.3 库存流水管理 (Stock Movement Ledger)**

- **功能描述：** 像银行账单一样，忠实记录每一次引起库存数量变化的事件。
- **核心功能：**
  - **自动生成流水：** 系统在执行以下操作时，必须自动创建一条不可修改的库存流水记录。
  - **变动类型包括：** `采购入库`、`销售出库`、`调拨出库`、`调拨入库`、`盘盈`、`盘亏`、`报损出库`、`组合商品销售`、`退货入库`等。
  - **流水核心字段：** `流水ID`、`时间`、`SKU`、`地点`、`变动类型`、`变动前数量`、`变动数量`、`变动后数量`、`关联单据号`（如PO-12345）、`操作人`。

#### **4.4 库存盘点管理 (Stocktaking Management)**

- **功能描述：** 通过计划性的实物清点，确保账实相符。

- **盘点流程：**

  

  ```mermaid
  graph TD
      A[创建盘点任务] --> B[执行盘点];
      B --> C[录入盘点数据];
      C --> D[生成差异报告];
      D --> E{主管审核差异};
      E -- 审核通过 --> F[库存调整];
      E -- 驳回 --> C;
      F --> G[盘点任务完成];
  ```

- **核心功能：**

  - **创建盘点任务：**
    - 选择盘点范围：`全盘`（整个仓库）或`循环盘点`（按商品分类、货架、品牌等）。
    - 任务创建后，系统会“冻结”或记录下当前范围内的商品账面数量，作为比对基准。
  - **执行与录入：** 支持通过PDA/手机App扫描商品条码，快速录入`实盘数量`。
  - **差异报告与审核：** 系统自动计算`盘盈`、`盘亏`的数量和金额。差异报告需经主管审核，确认是执行调整还是重新盘点。
  - **库存调整：** 审核通过后，系统自动生成`盘盈`入库单或`盘亏`出库单，并计入库存流水，完成账面库存的校准。

#### **4.5 保质期与库存状态预警 (Shelf-Life & Alerts)**

- **功能描述：** 对库存进行健康度监控，主动发现并提示风险。
- **核心功能：**
  - **保质期管理：**
    - 在`商品中心`为SKU设置保质期天数。
    - 在`采购入库`时，要求录入该批次商品的`生产日期`或`到期日`。
    - 系统自动计算并展示商品的剩余保质期。
  - **预警机制：**
    - `临期预警`：当商品剩余保质期低于预设阈值（如30天），系统自动生成预警列表，提示运营人员进行促销或优先出库处理。
    - `呆滞库存预警`：当商品在预设天数内（如60天）无任何销售出库记录时，进行预警。
    - `超储预警`：当商品库存量超过设定的最高库存时，进行预警。

#### **4.6 库存成本核算 (Inventory Costing)**

- **功能描述：** 采用加权平均法，在每次采购入库后，重新计算SKU的库存单位成本。

- **核算方法：** **加权平均法 (Weighted Average Cost Method)**

- **计算触发时机：** **仅在“采购入库”时**触发成本重算。

- **计算公式：**

  $$$$$$\\text{新加权平均成本} = \\frac{(\\text{原库存数量} \\times \\text{原加权平均成本}) + (\\text{本次入库数量} \\times \\text{本次入库单价})}{\\text{原库存数量} + \\text{本次入库数量}}$$

  $$$$

  **成本应用：**

  - 所有**出库类**操作（如销售、报损、盘亏、调拨），其成本都以上一次计算出的`加权平均成本`为准。
  - 该成本是计算销售毛利（`售价 - 成本`）的关键依据。

