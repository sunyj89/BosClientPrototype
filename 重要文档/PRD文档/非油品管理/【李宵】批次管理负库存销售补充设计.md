# 非油进销存系统 - 批次管理负库存销售补充设计

## 1. 负库存销售机制概述

### 1.1 业务场景定义

负库存销售是指在商品实际库存不足的情况下，系统允许先进行销售交易，形成负库存状态，待后续入库时再进行库存回填的业务场景。这种机制主要适用于以下情况：

- 紧急销售需求，但商品尚未完成入库流程
- 供应商已发货但尚未到达仓库的在途商品销售
- 特殊客户的急需商品，允许先销售后补货
- POS端与后台系统库存同步延迟导致的临时负库存

### 1.2 负库存销售基本流程

1. **销售阶段**
   - 系统检测到商品库存不足但允许负库存销售
   - 记录销售订单并标记为"负库存销售"
   - 生成负库存记录，等待后续入库回填
   - 销售成本暂时为空，待入库后回填

2. **入库回填阶段**
   - 商品入库时，系统自动检测是否存在待回填的负库存记录
   - 按照负库存销售的时间顺序（FIFO原则）进行回填
   - 更新销售成本和库存状态
   - 生成负库存回填记录，用于后续追溯

## 2. 负库存销售批次管理机制

### 2.1 负库存批次生成规则

| 数据项 | 计算逻辑 | 单位 | 小数位 | 说明 |
|-------|---------|------|-------|------|
| 负库存批次编号 | 系统自动生成 | - | - | 编码规则：NEG+年月日+销售单号+2位序号 |
| 关联销售单号 | 直接引用 | - | - | 用于追溯负库存来源 |
| 商品ID | 来源于销售单 | - | - | 负库存对应的商品 |
| 负库存数量 | 销售数量 | 基本计量单位 | 0位小数 | 记录为负值 |
| 负库存单价 | 销售时为空，入库回填后更新 | 元/基本单位 | 4位小数 | 回填后的成本单价 |
| 负库存金额 | 销售时为空，入库回填后更新 | 元 | 2位小数 | 回填后的成本金额 |
| 销售日期 | 销售单日期 | 日期 | - | 负库存产生的日期 |
| 回填状态 | 系统自动更新 | - | - | 包括：待回填、部分回填、已回填 |

### 2.2 负库存回填规则

| 回填类型 | 处理规则 | 应用场景 | 说明 |
|---------|---------|---------|------|
| 完全回填 | 一次入库完全回填负库存 | 入库数量≥负库存数量 | 负库存状态直接更新为"已回填" |
| 部分回填 | 一次入库部分回填负库存 | 入库数量<负库存数量 | 负库存状态更新为"部分回填"，剩余部分等待下次入库 |
| 多批次回填 | 多次入库完成负库存回填 | 负库存数量较大 | 记录每次回填的批次和数量，用于成本加权计算 |
| 优先级回填 | 按销售时间顺序回填 | 存在多笔负库存 | 优先回填最早产生的负库存 |

### 2.3 负库存批次状态管理

| 批次状态 | 状态描述 | 触发条件 | 允许操作 |
|---------|---------|---------|----------|
| 待回填 | 负库存尚未回填 | 负库存销售产生时 | 查看、取消（特殊情况） |
| 部分回填 | 负库存部分回填 | 入库数量不足以完全回填 | 查看、继续回填 |
| 已回填 | 负库存完全回填 | 回填数量达到负库存数量 | 查看、追溯 |
| 已取消 | 负库存销售取消 | 特殊情况下取消负库存销售 | 查看记录 |

## 3. 负库存销售成本核算机制

### 3.1 负库存成本确定原则

负库存销售的商品成本应为后续入库的商品成本，具体规则如下：

| 成本确定场景 | 计算规则 | 应用条件 | 说明 |
|------------|---------|---------|------|
| 单次完全回填 | 直接使用入库批次成本 | 一次入库完全回填 | 负库存成本 = 入库批次成本 |
| 部分回填 | 分段记录每次回填成本 | 入库数量<负库存数量 | 记录每次回填的数量和对应成本 |
| 多批次回填 | 加权平均计算最终成本 | 多次入库完成回填 | 负库存成本 = Σ(回填数量×回填批次成本)/负库存总数量 |

### 3.2 多批次回填成本计算示例

假设一笔负库存销售数量为100个，分三次入库回填：

1. 第一次入库30个，单价10元
2. 第二次入库50个，单价12元
3. 第三次入库20个，单价15元

则该笔负库存销售的成本计算为：

```
加权平均成本 = (30×10 + 50×12 + 20×15) ÷ 100 = (300 + 600 + 300) ÷ 100 = 1200 ÷ 100 = 12元
```

### 3.3 负库存成本核算数据项

| 数据项 | 计算逻辑 | 单位 | 小数位 | 说明 |
|-------|---------|------|-------|------|
| 回填批次ID | 系统记录 | - | - | 用于记录哪个批次回填了负库存 |
| 回填数量 | 本次回填的数量 | 基本计量单位 | 0位小数 | 单次回填的数量 |
| 回填批次成本 | 入库批次的单位成本 | 元/基本单位 | 4位小数 | 回填批次的成本单价 |
| 回填成本金额 | 回填数量 × 回填批次成本 | 元 | 2位小数 | 本次回填的成本金额 |
| 累计回填数量 | 所有回填记录数量之和 | 基本计量单位 | 0位小数 | 用于判断是否完全回填 |
| 累计回填金额 | 所有回填记录金额之和 | 元 | 2位小数 | 用于计算加权平均成本 |
| 加权平均成本 | 累计回填金额 ÷ 累计回填数量 | 元/基本单位 | 4位小数 | 最终的负库存成本 |
| 回填时间 | 系统记录操作时间 | 日期时间 | - | 回填操作的时间 |

### 3.4 负库存成本调整机制

| 调整场景 | 处理方式 | 触发条件 | 说明 |
|---------|---------|---------|------|
| 价格波动较大 | 特殊标记并通知 | 回填批次价格波动超过阈值 | 系统提醒可能存在异常价格波动 |
| 负库存取消 | 冲销负库存记录 | 负库存销售被取消 | 删除负库存记录，恢复正常库存状态 |
| 财务期间结转 | 估算未回填负库存成本 | 财务期末仍有未回填负库存 | 使用最近采购价或标准成本进行暂估 |
| 暂估调整 | 实际回填后调整差异 | 暂估成本与实际回填成本不同 | 在实际回填后调整成本差异 |

## 4. 负库存销售系统实现

### 4.1 数据库设计补充

#### 4.1.1 负库存记录表（negative_inventory_records）

| 字段名 | 数据类型 | 说明 | 约束 |
|--------|----------|------|------|
| record_id | INT | 记录ID | 主键 |
| org_id | INT | 所属组织ID | 非空，外键 |
| product_id | INT | 商品ID | 非空，外键 |
| sales_order_id | INT | 销售订单ID | 非空，外键 |
| negative_quantity | DECIMAL(12,4) | 负库存数量 | 非空，负值 |
| sales_date | DATE | 销售日期 | 非空 |
| filled_quantity | DECIMAL(12,4) | 已回填数量 | 非空，默认0 |
| filled_amount | DECIMAL(12,2) | 已回填金额 | 非空，默认0 |
| avg_cost | DECIMAL(12,4) | 加权平均成本 | 可空 |
| status | ENUM | 状态 | 非空，可选值：pending, partially_filled, filled, cancelled |
| created_at | DATETIME | 创建时间 | 默认当前时间 |
| updated_at | DATETIME | 更新时间 | 自动更新 |

#### 4.1.2 负库存回填记录表（negative_inventory_fills）

| 字段名 | 数据类型 | 说明 | 约束 |
|--------|----------|------|------|
| fill_id | INT | 回填ID | 主键 |
| record_id | INT | 负库存记录ID | 非空，外键 |
| batch_id | INT | 回填批次ID | 非空，外键 |
| fill_quantity | DECIMAL(12,4) | 回填数量 | 非空，正值 |
| batch_cost | DECIMAL(12,4) | 批次成本 | 非空 |
| fill_amount | DECIMAL(12,2) | 回填金额 | 非空 |
| fill_date | DATE | 回填日期 | 非空 |
| created_at | DATETIME | 创建时间 | 默认当前时间 |
| updated_at | DATETIME | 更新时间 | 自动更新 |

### 4.2 业务规则实现

#### 4.2.1 负库存销售触发条件

```sql
CREATE TRIGGER trg_check_negative_inventory
BEFORE INSERT ON sales_order_items
FOR EACH ROW
BEGIN
    DECLARE available_qty DECIMAL(12,4);
    
    -- 获取可用库存
    SELECT SUM(quantity) INTO available_qty 
    FROM inventory_batches 
    WHERE product_id = NEW.product_id AND org_id = NEW.org_id;
    
    -- 检查是否允许负库存销售
    IF available_qty < NEW.quantity THEN
        -- 检查商品是否允许负库存销售
        IF NOT EXISTS (SELECT 1 FROM products WHERE product_id = NEW.product_id AND allow_negative_inventory = 1) THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '库存不足且不允许负库存销售';
        END IF;
        
        -- 标记为负库存销售
        SET NEW.is_negative_inventory = 1;
    ELSE
        SET NEW.is_negative_inventory = 0;
    END IF;
END;
```

#### 4.2.2 负库存记录生成

```sql
CREATE TRIGGER trg_create_negative_inventory_record
AFTER INSERT ON sales_order_items
FOR EACH ROW
BEGIN
    DECLARE v_sales_date DATE;
    
    IF NEW.is_negative_inventory = 1 THEN
        -- 获取销售日期
        SELECT order_date INTO v_sales_date 
        FROM sales_orders 
        WHERE order_id = NEW.order_id;
        
        -- 创建负库存记录
        INSERT INTO negative_inventory_records (
            org_id, product_id, sales_order_id, negative_quantity, 
            sales_date, filled_quantity, filled_amount, status
        ) VALUES (
            NEW.org_id, NEW.product_id, NEW.order_id, -NEW.quantity, 
            v_sales_date, 0, 0, 'pending'
        );
    END IF;
END;
```

#### 4.2.3 入库时负