<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.microservice.invoice.mapper.StationInvoiceConfigMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.microservice.invoice.entity.StationInvoiceConfig">
        <id column="id" property="id" />
        <result column="merchant_id" property="merchantId" />
        <result column="merchant_type" property="merchantType" />
        <result column="station_name" property="stationName" />
        <result column="provider_type" property="providerType" />
        <result column="default_invoice_merchant" property="defaultInvoiceMerchant" />
        <result column="taxpayer_id" property="taxpayerId" />
        <result column="bank_name" property="bankName" />
        <result column="bank_account" property="bankAccount" />
        <result column="station_address" property="stationAddress" />
        <result column="station_phone" property="stationPhone" />
        <result column="payee" property="payee" />
        <result column="reviewer" property="reviewer" />
        <result column="drawer" property="drawer" />
        <result column="paper_invoice_tax_disk_no" property="paperInvoiceTaxDiskNo" />
        <result column="electronic_invoice_tax_disk_no" property="electronicInvoiceTaxDiskNo" />
        <result column="extension_no" property="extensionNo" />
        <result column="drawer_email" property="drawerEmail" />
        <result column="invoice_validity_period_in_hours" property="invoiceValidityPeriodInHours" />
        <result column="consumption_record_entry_enabled" property="consumptionRecordEntryEnabled" />
        <result column="payment_complete_entry_enabled" property="paymentCompleteEntryEnabled" />
        <result column="senseless_payment_auto_invoice_enabled" property="senselessPaymentAutoInvoiceEnabled" />
        <result column="paper_invoice_option_enabled" property="paperInvoiceOptionEnabled" />
        <result column="invoice_amount_basis" property="invoiceAmountBasis" />
        <result column="recharge_default_oil" property="rechargeDefaultOil" />
        <result column="provider_specific_config" property="providerSpecificConfig" 
                typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler" />
        <result column="start_time" property="startTime" />
        <result column="end_time" property="endTime" />
        <result column="created_time" property="createdTime" />
        <result column="updated_time" property="updatedTime" />
        <result column="deleted_time" property="deletedTime" />
        <result column="created_by" property="createdBy" />
        <result column="updated_by" property="updatedBy" />
        <result column="deleted" property="deleted" />
    </resultMap>

    <!-- 检查时间冲突 -->
    <select id="countTimeConflicts" resultType="int">
        SELECT COUNT(*)
        FROM station_invoice_configs
        WHERE merchant_id = #{stationId}
          AND deleted = 0
          <if test="excludeId != null">
              AND id != #{excludeId}
          </if>
          AND start_time &lt; #{endTime}
          AND (end_time IS NULL OR end_time &gt; #{startTime})
    </select>

    <!-- 获取当前生效的配置 -->
    <select id="getActiveConfig" resultMap="BaseResultMap">
        SELECT *
        FROM station_invoice_configs
        WHERE merchant_id = #{stationId}
          AND deleted = 0
          AND start_time &lt;= #{currentTime}
          AND (end_time IS NULL OR end_time &gt; #{currentTime})
        LIMIT 1
    </select>

    <!-- 根据状态获取配置列表 -->
    <select id="getConfigsByStatus" resultMap="BaseResultMap">
        SELECT *
        FROM station_invoice_configs
        WHERE merchant_id = #{stationId}
          AND deleted = 0
          <if test="status == 'pending'">
              AND start_time &gt; #{currentTime}
          </if>
          <if test="status == 'active'">
              AND start_time &lt;= #{currentTime}
              AND (end_time IS NULL OR end_time &gt; #{currentTime})
          </if>
          <if test="status == 'expired'">
              AND end_time IS NOT NULL
              AND end_time &lt;= #{currentTime}
          </if>
        ORDER BY start_time DESC
    </select>

</mapper>