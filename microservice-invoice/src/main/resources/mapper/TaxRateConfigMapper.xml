<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.microservice.invoice.mapper.TaxRateConfigMapper">

    <!-- 税率配置列表查询结果映射 -->
    <resultMap id="TaxRateConfigListVOMap" type="com.microservice.invoice.vo.TaxRateConfigListVO">
        <id column="id" property="id"/>
        <result column="merchant_id" property="merchantId"/>
        <result column="product_name" property="productName"/>
        <result column="product_code" property="productCode"/>
        <result column="tax_rate" property="taxRate"/>
        <result column="unit" property="unit"/>
        <result column="spbm" property="spbm"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
    </resultMap>

    <!-- 分页查询税率配置列表 -->
    <select id="selectTaxRateConfigPage" resultMap="TaxRateConfigListVOMap">
        SELECT
            id,
            merchant_id,
            merchant_type,
            product_name,
            product_code,
            tax_rate,
            unit,
            spbm,
            created_time,
            updated_time,
            created_by,
            updated_by
        FROM tax_rate_config
        <where>
            deleted = 0
            <if test="query.merchantId != null">
                AND merchant_id = #{query.merchantId}
            </if>
            <if test="query.productName != null and query.productName != ''">
                AND product_name LIKE CONCAT('%', #{query.productName}, '%')
            </if>
            <if test="query.productCode != null and query.productCode != ''">
                AND product_code LIKE CONCAT('%', #{query.productCode}, '%')
            </if>
            <if test="query.unit != null and query.unit != ''">
                AND unit = #{query.unit}
            </if>
            <if test="query.spbm != null and query.spbm != ''">
                AND spbm LIKE CONCAT('%', #{query.spbm}, '%')
            </if>
            <if test="query.taxRateMin != null">
                AND tax_rate &gt;= #{query.taxRateMin}
            </if>
            <if test="query.taxRateMax != null">
                AND tax_rate &lt;= #{query.taxRateMax}
            </if>
            <if test="query.startTime != null">
                AND created_time &gt;= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND created_time &lt;= #{query.endTime}
            </if>
        </where>
        <choose>
            <when test="query.sortBy != null and query.sortBy != ''">
                ORDER BY 
                <choose>
                    <when test="query.sortBy == 'merchantId'">merchant_id</when>
                    <when test="query.sortBy == 'productName'">product_name</when>
                    <when test="query.sortBy == 'productCode'">product_code</when>
                    <when test="query.sortBy == 'taxRate'">tax_rate</when>
                    <when test="query.sortBy == 'unit'">unit</when>
                    <when test="query.sortBy == 'spbm'">spbm</when>
                    <when test="query.sortBy == 'createdTime'">created_time</when>
                    <when test="query.sortBy == 'updatedTime'">updated_time</when>
                    <otherwise>created_time</otherwise>
                </choose>
                <choose>
                    <when test="query.sortOrder == 'asc'">ASC</when>
                    <otherwise>DESC</otherwise>
                </choose>
            </when>
            <otherwise>
                ORDER BY id DESC
            </otherwise>
        </choose>
    </select>

    <!-- 根据油站ID和油品代码查询税率配置 -->
    <select id="getTaxRateConfigByStationAndProduct" resultType="com.microservice.invoice.entity.TaxRateConfig">
        SELECT * FROM tax_rate_config 
        WHERE deleted = 0 
        AND merchant_id = #{merchantId} 
        AND product_code = #{productCode}
        LIMIT 1
    </select>

    <!-- 根据油站ID查询所有税率配置 -->
    <select id="getTaxRateConfigsByStationId" resultType="com.microservice.invoice.entity.TaxRateConfig">
        SELECT * FROM tax_rate_config 
        WHERE deleted = 0 
        AND merchant_id = #{merchantId}
        ORDER BY product_code ASC
    </select>

</mapper>