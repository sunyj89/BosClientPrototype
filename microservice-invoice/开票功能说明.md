# 开票功能说明

## 功能概述

本模块提供了完整的电子发票开具功能，支持油品和非油品两种类型的发票开具。

## 功能特性

1. **发票类型支持**
   - 油品发票开具
   - 非油品发票开具
   - 支持数电专票和数电普票

2. **发票管理功能**
   - 发票抬头管理（增删改查）
   - 开票记录查询
   - 发票PDF下载
   - 发票邮件发送
   - 发票冲红
   - 重新开票

3. **站点配置管理**
   - 站点开票信息配置
   - 支持多种开票服务商（百旺乐企）
   - 税率配置管理

## API接口说明

### 1. 非油品开票接口
```
POST /api/v1/invoices/non-oil
```

请求示例：
```json
{
    "merchantId": 2001,
    "buyerTaxpayerId": "9X0001GGMACM2L8N6B",
    "buyerName": "江西省交投化石能源有限公司虚拟单位",
    "drawer": "测试",
    "details": [
        {
            "productShortName": "专项化学用品",
            "itemName": "悦泰海龙柴油车尾气处理液20Kg",
            "goodsName": "*专项化学用品*悦泰海龙柴油车尾气处理液20Kg",
            "unit": "瓶",
            "quantity": 1.00,
            "unitPrice": 88.50,
            "taxRate": 0.13,
            "taxClassificationCode": "1070215020000000000"
        }
    ]
}
```

响应示例：
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "invoiceRequestNo": "NON_OIL_1737366000000_12345678",
        "invoiceNo": "00000001",
        "invoiceDate": "2025-01-18 15:00:00",
        "status": 0,
        "message": "成功"
    }
}
```

### 2. 油品开票接口
```
POST /api/v1/invoices/oil
```

参数：
- orderId: 订单ID
- userId: 用户ID
- invoiceHeaderId: 发票抬头ID

### 3. 查询发票PDF地址
```
GET /api/v1/invoices/{id}/pdf-url
```

### 4. 发票冲红
```
POST /api/v1/invoices/{id}/reverse
```

参数：
- reason: 冲红原因

### 5. 重新开票
```
POST /api/v1/invoices/{id}/retry
```

### 6. 发送发票邮件
```
POST /api/v1/invoices/{id}/send-email
```

参数：
- email: 邮箱地址

## 数据库设计

### 主要数据表

1. **invoice_record** - 开票记录表
   - 存储所有的开票记录信息
   - 包含买方、卖方信息
   - 发票状态和金额信息

2. **invoice_detail** - 发票明细表
   - 存储发票的商品明细信息
   - 包含商品名称、数量、单价、税率等

3. **invoice_header** - 发票抬头表
   - 存储用户的发票抬头信息
   - 支持多个抬头管理

4. **station_invoice_config** - 站点开票配置表
   - 存储各站点的开票配置信息
   - 包含销方信息、税盘配置等

5. **tax_rate_config** - 税率配置表
   - 存储不同商品类型的税率信息

## 开发进度

### 已完成功能
- ✅ 非油品开票API接口
- ✅ 开票服务实现
- ✅ 发票PDF查询功能
- ✅ 基础数据模型设计
- ✅ 发票抬头管理接口
- ✅ 开票记录查询接口
- ✅ 站点配置管理接口

### 待开发功能
- ⏳ 油品开票功能
- ⏳ 发票冲红功能
- ⏳ 重新开票功能
- ⏳ 发票邮件发送功能
- ⏳ 与实际开票服务商（百旺）的接口对接
- ⏳ 批量开票功能
- ⏳ 开票异步处理
- ⏳ 开票状态回调通知

## 注意事项

1. 开票前需要先配置站点的开票信息
2. 确保商品的税收分类编码正确
3. 开票金额计算需要考虑税率
4. 发票号码由开票服务商返回
5. 开票失败需要记录错误信息便于排查

## 部署说明

1. 确保已配置好数据库连接
2. 配置开票服务商的API地址和认证信息
3. 设置合适的文件存储路径（用于存储发票PDF）
4. 配置邮件服务器（用于发送发票邮件）