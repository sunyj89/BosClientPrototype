# 微信小程序发票功能模块架构设计 v1.0

## 1. 模块概述

### 1.1 功能定位
微信小程序发票模块是面向终端用户的自助开票平台，支持用户便捷地进行发票申请、管理和查询操作。

### 1.2 核心功能
- **自助开票**: 批量选择订单进行开票申请
- **扫码开票**: 扫描收银机小票二维码开票
- **抬头管理**: 个人和企业发票抬头维护
- **开票记录**: 历史开票记录查询和下载
- **统计查看**: 个人开票统计信息展示

## 2. 小程序目录结构设计

```
miniprogram/
├── pages/
│   ├── invoice/                    # 发票主模块
│   │   ├── index/                  # 发票首页
│   │   │   ├── index.js
│   │   │   ├── index.wxml
│   │   │   ├── index.wxss
│   │   │   └── index.json
│   │   ├── header-manage/          # 发票抬头管理
│   │   │   ├── index.js            # 抬头列表页
│   │   │   ├── index.wxml
│   │   │   ├── index.wxss
│   │   │   ├── add-edit/           # 新增编辑抬头
│   │   │   │   ├── index.js
│   │   │   │   ├── index.wxml
│   │   │   │   └── index.wxss
│   │   │   └── detail/             # 抬头详情
│   │   ├── self-service/           # 自助开票
│   │   │   ├── order-select/       # 订单选择页
│   │   │   │   ├── index.js
│   │   │   │   ├── index.wxml
│   │   │   │   └── index.wxss
│   │   │   ├── invoice-apply/      # 开票申请页
│   │   │   │   ├── index.js
│   │   │   │   ├── index.wxml
│   │   │   │   └── index.wxss
│   │   │   └── result/             # 开票结果页
│   │   ├── scan-code/              # 扫码开票
│   │   │   ├── index.js
│   │   │   ├── index.wxml
│   │   │   └── index.wxss
│   │   ├── records/                # 开票记录
│   │   │   ├── index.js            # 记录列表
│   │   │   ├── index.wxml
│   │   │   ├── index.wxss
│   │   │   └── detail/             # 记录详情
│   │   └── download/               # 发票下载页
├── components/
│   ├── invoice-card/               # 发票卡片组件
│   ├── order-item/                 # 订单项组件
│   ├── header-selector/            # 抬头选择器组件
│   └── amount-summary/             # 金额汇总组件
├── utils/
│   ├── invoice-api.js              # 发票接口封装
│   ├── order-api.js                # 订单接口封装
│   └── invoice-utils.js            # 发票工具函数
└── store/
    └── invoice-store.js            # 发票状态管理
```

## 3. 核心页面设计

### 3.1 发票首页 (pages/invoice/index)

#### 3.1.1 页面功能
- 快捷操作入口展示
- 最近开票记录展示
- 个人开票统计信息
- 常用功能快速访问

#### 3.1.2 页面布局
```xml
<!-- index.wxml -->
<view class="invoice-home">
  <!-- 统计卡片区域 -->
  <view class="stats-section">
    <view class="stats-card">
      <text class="stats-number">{{statistics.totalCount}}</text>
      <text class="stats-label">累计开票</text>
    </view>
    <view class="stats-card">
      <text class="stats-number">￥{{statistics.totalAmount}}</text>
      <text class="stats-label">累计金额</text>
    </view>
    <view class="stats-card">
      <text class="stats-number">{{statistics.thisMonthCount}}</text>
      <text class="stats-label">本月开票</text>
    </view>
  </view>

  <!-- 快捷操作区域 -->
  <view class="quick-actions">
    <view class="action-grid">
      <view 
        class="action-item" 
        wx:for="{{quickActions}}" 
        wx:key="id"
        bindtap="onQuickActionTap"
        data-path="{{item.path}}"
      >
        <image src="{{item.icon}}" class="action-icon" />
        <text class="action-name">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- 最近开票记录 -->
  <view class="recent-section">
    <view class="section-header">
      <text class="section-title">最近开票</text>
      <text class="more-btn" bindtap="onViewMoreRecords">查看更多</text>
    </view>
    <view class="recent-list">
      <invoice-card 
        wx:for="{{recentInvoices}}" 
        wx:key="id"
        invoice="{{item}}"
        show-actions="{{false}}"
      />
    </view>
  </view>
</view>
```

#### 3.1.3 核心逻辑
```javascript
// index.js
Page({
  data: {
    quickActions: [
      {
        id: 'self_service',
        name: '自助开票',
        icon: '/images/invoice/self-service.png',
        path: '/pages/invoice/self-service/order-select/index'
      },
      {
        id: 'scan_code',
        name: '扫码开票',
        icon: '/images/invoice/scan-code.png',
        path: '/pages/invoice/scan-code/index'
      },
      {
        id: 'records',
        name: '开票记录',
        icon: '/images/invoice/records.png',
        path: '/pages/invoice/records/index'
      },
      {
        id: 'header_manage',
        name: '抬头管理',
        icon: '/images/invoice/header.png',
        path: '/pages/invoice/header-manage/index'
      }
    ],
    recentInvoices: [],
    statistics: {
      totalAmount: 0,
      totalCount: 0,
      thisMonthCount: 0
    }
  },

  onLoad() {
    this.loadRecentInvoices();
    this.loadStatistics();
  },

  // 加载最近开票记录
  async loadRecentInvoices() {
    try {
      const res = await invoiceApi.getRecentInvoices({ pageSize: 5 });
      this.setData({ recentInvoices: res.data.list });
    } catch (error) {
      console.error('加载最近开票记录失败:', error);
    }
  },

  // 加载统计数据
  async loadStatistics() {
    try {
      const res = await invoiceApi.getInvoiceStatistics();
      this.setData({ statistics: res.data });
    } catch (error) {
      console.error('加载统计数据失败:', error);
    }
  },

  // 快捷操作点击
  onQuickActionTap(e) {
    const { path } = e.currentTarget.dataset;
    wx.navigateTo({ url: path });
  },

  // 查看更多记录
  onViewMoreRecords() {
    wx.navigateTo({ url: '/pages/invoice/records/index' });
  }
});
```

### 3.2 订单选择页 (pages/invoice/self-service/order-select)

#### 3.2.1 页面功能
- 可开票订单列表展示
- 多维度筛选功能
- 批量选择订单
- 开票金额汇总计算

#### 3.2.2 核心逻辑
```javascript
// pages/invoice/self-service/order-select/index.js
Page({
  data: {
    // 订单类型标签
    orderTypes: [
      { key: 'all', name: '全部', count: 0 },
      { key: 'fuel', name: '加油消费', count: 0 },
      { key: 'goods', name: '商品消费', count: 0 },
      { key: 'prepaid', name: '预付卡', count: 0 },
      { key: 'points', name: '积分商城', count: 0 }
    ],
    
    activeOrderType: 'all',
    orderList: [],
    selectedOrders: [],
    
    // 筛选条件
    filters: {
      startDate: '',
      endDate: '',
      minAmount: '',
      maxAmount: ''
    },
    
    // 汇总信息
    summary: {
      selectedCount: 0,
      totalAmount: 0,
      invoiceAmount: 0
    },
    
    loading: false,
    hasMore: true,
    page: 1,
    pageSize: 20
  },

  onLoad() {
    this.loadOrders();
    this.loadOrderTypeCounts();
  },

  // 加载订单列表
  async loadOrders(refresh = false) {
    if (this.data.loading) return;
    
    this.setData({ loading: true });
    
    try {
      const params = {
        page: refresh ? 1 : this.data.page,
        pageSize: this.data.pageSize,
        orderType: this.data.activeOrderType,
        invoiceStatus: 'can_invoice',
        ...this.data.filters
      };
      
      const res = await orderApi.getInvoiceableOrders(params);
      
      const orderList = refresh ? res.data.list : 
        [...this.data.orderList, ...res.data.list];
      
      this.setData({
        orderList,
        hasMore: res.data.page < res.data.totalPages,
        page: refresh ? 2 : this.data.page + 1,
        loading: false
      });
    } catch (error) {
      this.setData({ loading: false });
      wx.showToast({ title: '加载失败', icon: 'error' });
    }
  },

  // 订单类型切换
  onOrderTypeChange(e) {
    const { type } = e.currentTarget.dataset;
    this.setData({
      activeOrderType: type,
      orderList: [],
      selectedOrders: [],
      page: 1,
      hasMore: true
    });
    this.loadOrders(true);
    this.updateSummary();
  },

  // 订单选择/取消选择
  onOrderToggle(e) {
    const { order } = e.currentTarget.dataset;
    const { selectedOrders } = this.data;
    
    const index = selectedOrders.findIndex(item => item.id === order.id);
    
    if (index > -1) {
      selectedOrders.splice(index, 1);
    } else {
      selectedOrders.push(order);
    }
    
    this.setData({ selectedOrders });
    this.updateSummary();
  },

  // 更新汇总信息
  updateSummary() {
    const { selectedOrders } = this.data;
    
    const summary = {
      selectedCount: selectedOrders.length,
      totalAmount: selectedOrders.reduce((sum, order) => sum + order.totalAmount, 0),
      invoiceAmount: selectedOrders.reduce((sum, order) => sum + order.invoiceableAmount, 0)
    };
    
    this.setData({ summary });
  },

  // 下一步 - 去开票
  onNextStep() {
    const { selectedOrders } = this.data;
    
    if (selectedOrders.length === 0) {
      wx.showToast({ title: '请选择订单', icon: 'none' });
      return;
    }
    
    wx.navigateTo({
      url: `/pages/invoice/self-service/invoice-apply/index?orders=${encodeURIComponent(JSON.stringify(selectedOrders))}`
    });
  }
});
```

### 3.3 扫码开票页 (pages/invoice/scan-code)

#### 3.3.1 页面功能
- 扫描收银机小票二维码
- 解析二维码获取订单信息
- 选择发票抬头
- 提交开票申请

#### 3.3.2 核心逻辑
```javascript
// pages/invoice/scan-code/index.js
Page({
  data: {
    scanResult: null,
    orderInfo: null,
    selectedHeader: null,
    invoicing: false
  },

  onLoad() {
    this.startScan();
  },

  // 开始扫码
  startScan() {
    wx.scanCode({
      onlyFromCamera: true,
      scanType: ['qrCode'],
      success: (res) => {
        this.handleScanResult(res.result);
      },
      fail: () => {
        wx.showToast({ title: '扫码取消', icon: 'none' });
        setTimeout(() => wx.navigateBack(), 1500);
      }
    });
  },

  // 处理扫码结果
  async handleScanResult(scanData) {
    try {
      wx.showLoading({ title: '解析中...' });
      
      const orderInfo = await this.parseReceiptQRCode(scanData);
      
      wx.hideLoading();
      
      this.setData({
        scanResult: scanData,
        orderInfo
      });
      
      this.loadDefaultHeader();
      
    } catch (error) {
      wx.hideLoading();
      wx.showModal({
        title: '提示',
        content: error.message || '无法识别的二维码',
        showCancel: false,
        success: () => wx.navigateBack()
      });
    }
  },

  // 解析收银机小票二维码
  async parseReceiptQRCode(scanData) {
    try {
      const res = await orderApi.parseReceiptQRCode({ qrData: scanData });
      return res.data;
    } catch (error) {
      throw new Error('无法解析小票信息');
    }
  },

  // 提交开票申请
  async onSubmitInvoice() {
    if (this.data.invoicing) return;
    
    const { orderInfo, selectedHeader } = this.data;
    
    if (!selectedHeader) {
      wx.showToast({ title: '请选择发票抬头', icon: 'none' });
      return;
    }
    
    this.setData({ invoicing: true });
    
    try {
      const params = {
        orderCode: orderInfo.orderCode,
        headerInfo: selectedHeader,
        invoiceType: '02'
      };
      
      await invoiceApi.submitScanInvoice(params);
      
      wx.showModal({
        title: '开票申请已提交',
        content: '请在"开票记录"中查看开票进度',
        showCancel: false,
        success: () => wx.navigateBack()
      });
      
    } catch (error) {
      this.setData({ invoicing: false });
      wx.showToast({
        title: error.message || '提交失败',
        icon: 'error'
      });
    }
  }
});
```

## 4. 核心组件设计

### 4.1 发票卡片组件 (components/invoice-card)

#### 4.1.1 组件功能
- 发票信息展示
- 状态标识
- 操作按钮

#### 4.1.2 组件实现
```javascript
// components/invoice-card/index.js
Component({
  properties: {
    invoice: {
      type: Object,
      value: {}
    },
    showActions: {
      type: Boolean,
      value: true
    }
  },

  methods: {
    // 查看详情
    onViewDetail() {
      this.triggerEvent('detail', { invoice: this.properties.invoice });
    },

    // 下载发票
    onDownload() {
      this.triggerEvent('download', { invoice: this.properties.invoice });
    },

    // 发送邮件
    onSendEmail() {
      this.triggerEvent('sendEmail', { invoice: this.properties.invoice });
    }
  }
});
```

```xml
<!-- components/invoice-card/index.wxml -->
<view class="invoice-card">
  <view class="invoice-header">
    <view class="invoice-info">
      <text class="invoice-no">发票号码: {{invoice.invoiceNo || '待生成'}}</text>
      <text class="invoice-date">开票日期: {{invoice.invoiceDate || '--'}}</text>
    </view>
    <view class="invoice-status">
      <text class="status-tag status-{{invoice.invoiceStatus}}">
        {{invoice.statusText}}
      </text>
    </view>
  </view>
  
  <view class="invoice-content">
    <view class="buyer-info">
      <text class="buyer-name">{{invoice.buyerName}}</text>
      <text class="order-code">订单号: {{invoice.orderCode}}</text>
    </view>
    <view class="amount-info">
      <text class="amount">￥{{invoice.totalAmountWithTax}}</text>
    </view>
  </view>
  
  <view class="invoice-actions" wx:if="{{showActions && invoice.invoiceStatus === '02'}}">
    <button class="action-btn" size="mini" bindtap="onViewDetail">详情</button>
    <button class="action-btn" size="mini" bindtap="onDownload">下载</button>
    <button class="action-btn" size="mini" bindtap="onSendEmail">邮件</button>
  </view>
</view>
```

### 4.2 抬头选择器组件 (components/header-selector)

#### 4.2.1 组件功能
- 发票抬头列表展示
- 抬头选择
- 新增抬头

#### 4.2.2 组件实现
```javascript
// components/header-selector/index.js
Component({
  properties: {
    visible: {
      type: Boolean,
      value: false
    },
    headerList: {
      type: Array,
      value: []
    },
    selectedHeader: {
      type: Object,
      value: null
    }
  },

  methods: {
    // 选择抬头
    onSelectHeader(e) {
      const { header } = e.currentTarget.dataset;
      this.triggerEvent('select', { header });
    },

    // 新增抬头
    onAddHeader() {
      this.triggerEvent('add');
    },

    // 关闭选择器
    onClose() {
      this.triggerEvent('close');
    }
  }
});
```

## 5. 接口封装设计

### 5.1 统一API封装 (utils/invoice-api.js)

```javascript
const baseUrl = 'https://api.example.com/invoice';

class InvoiceAPI {
  // 获取可开票订单
  async getInvoiceableOrders(params) {
    return await this.request('/api/v1/orders/invoiceable', 'GET', params);
  }

  // 提交开票申请
  async submitInvoiceApplication(data) {
    return await this.request('/api/v1/invoice/apply', 'POST', data);
  }

  // 获取开票记录
  async getInvoiceRecords(params) {
    return await this.request('/api/v1/invoice-records', 'GET', params);
  }

  // 获取发票详情
  async getInvoiceDetail(id) {
    return await this.request(`/api/v1/invoice-records/${id}`, 'GET');
  }

  // 获取发票下载地址
  async getInvoiceDownloadUrl(params) {
    return await this.request('/api/v1/invoice/download-url', 'POST', params);
  }

  // 获取发票抬头列表
  async getInvoiceHeaders() {
    return await this.request('/api/v1/invoice/headers', 'GET');
  }

  // 保存发票抬头
  async saveInvoiceHeader(data) {
    return await this.request('/api/v1/invoice/headers', 'POST', data);
  }

  // 删除发票抬头
  async deleteInvoiceHeader(id) {
    return await this.request(`/api/v1/invoice/headers/${id}`, 'DELETE');
  }

  // 统一请求方法
  async request(url, method = 'GET', data = {}) {
    return new Promise((resolve, reject) => {
      wx.request({
        url: baseUrl + url,
        method,
        data,
        header: {
          'Content-Type': 'application/json',
          'Authorization': wx.getStorageSync('token')
        },
        success: (res) => {
          if (res.data.code === 0) {
            resolve(res.data);
          } else {
            reject(new Error(res.data.message));
          }
        },
        fail: reject
      });
    });
  }
}

export default new InvoiceAPI();
```

## 6. 工具函数设计

### 6.1 发票工具函数 (utils/invoice-utils.js)

```javascript
// 发票工具函数
export const InvoiceUtils = {
  
  // 格式化发票状态
  formatInvoiceStatus(status) {
    const statusMap = {
      '00': { text: '待开票', color: 'orange' },
      '01': { text: '开票中', color: 'blue' },
      '02': { text: '开票成功', color: 'green' },
      '03': { text: '开票失败', color: 'red' }
    };
    return statusMap[status] || { text: '未知', color: 'gray' };
  },

  // 格式化金额
  formatAmount(amount) {
    if (!amount) return '0.00';
    return Number(amount).toFixed(2);
  },

  // 验证税号格式
  validateTaxNumber(taxNumber) {
    if (!taxNumber) return false;
    return /^[A-Z0-9]{15,20}$/.test(taxNumber);
  },

  // 计算开票金额
  calculateInvoiceAmount(orders) {
    return orders.reduce((total, order) => {
      return total + (order.invoiceableAmount || 0);
    }, 0);
  },

  // 获取发票类型文本
  getInvoiceTypeText(type) {
    const typeMap = {
      '01': '数电专票',
      '02': '数电普票'
    };
    return typeMap[type] || '未知类型';
  },

  // 检查订单是否可开票
  canInvoiceOrder(order) {
    return order.payStatus === 'PAID' && 
           order.invoiceStatus !== 'FULLY_INVOICED' &&
           order.invoiceableAmount > 0;
  }
};
```

## 7. 性能优化策略

### 7.1 数据加载优化
- **分页加载**: 长列表采用分页加载机制
- **懒加载**: 图片和非关键数据懒加载
- **缓存策略**: 发票抬头等稳定数据本地缓存

### 7.2 用户体验优化
- **Loading状态**: 异步操作显示加载状态
- **错误处理**: 友好的错误提示和重试机制
- **操作反馈**: 及时的操作结果反馈

### 7.3 代码优化
- **组件复用**: 提取通用组件避免重复开发
- **事件节流**: 防止频繁点击和重复请求
- **内存管理**: 及时清理事件监听和定时器

## 8. 测试策略

### 8.1 功能测试
- **基础功能**: 开票申请、记录查询、抬头管理
- **异常场景**: 网络异常、数据异常、权限异常
- **边界测试**: 大数据量、极值输入、并发操作

### 8.2 兼容性测试
- **设备兼容**: 不同型号手机和操作系统
- **微信版本**: 不同微信版本兼容性
- **网络环境**: 不同网络状况下的表现

### 8.3 性能测试
- **加载速度**: 页面加载和数据获取速度
- **内存使用**: 长时间使用的内存占用
- **流畅度**: 页面切换和滚动流畅度

---

**文档版本**: v1.0  
**创建日期**: 2025-08-27  
**创建人**: 孙杨竣