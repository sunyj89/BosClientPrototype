# 组织结构和角色设计业务流程图文档

**文档版本：** v1.0  
**创建日期：** 2025年7月8日  
**最后更新：** 2025年7月8日

## 1. 文档概述

本文档详细描述了组织结构和角色设计模块的核心业务流程，通过流程图的形式展示系统的业务逻辑和操作步骤。

## 2. 核心业务流程

### 2.1 组织架构管理流程

```mermaid
flowchart TD
    A[用户访问组织架构管理页面] --> B[系统初始化]
    B --> C[调用loadTreeData函数]
    C --> D[调用getOrgTree API]
    D --> E[获取组织树数据]
    E --> F[OrgTree组件渲染树结构]
    F --> G[用户选择组织节点]
    G --> H{需要创建子组织？}
    H -->|是| I[点击新增子组织按钮]
    H -->|否| K[查看组织详情]
    I --> J[打开AddOrgModal弹窗]
    J --> L[填写组织信息]
    L --> M[选择组织类型]
    M --> N[选择法人主体]
    N --> O[验证层级关系]
    O --> P{验证通过？}
    P -->|是| Q[调用addOrgUnit API]
    P -->|否| R[显示错误提示]
    Q --> S[保存到数据库]
    S --> T[刷新组织树]
    T --> U[显示新增成功]
    R --> L
    K --> V[显示组织详情]
    
    style A fill:#e1f5fe
    style U fill:#c8e6c9
    style R fill:#ffcdd2
```

### 2.2 用户人员管理流程

```mermaid
flowchart TD
    A[用户选择组织节点] --> B[系统触发handleNodeSelect]
    B --> C[调用getUsersByOrgId API]
    C --> D[获取员工列表数据]
    D --> E[UserList组件渲染表格]
    E --> F{用户操作类型}
    F -->|添加用户| G[点击添加用户按钮]
    F -->|编辑用户| H[点击编辑按钮]
    F -->|删除用户| I[点击删除按钮]
    
    G --> J[打开用户编辑弹窗]
    J --> K[预设组织信息]
    K --> L[填写用户姓名]
    L --> M[选择角色]
    M --> N[提交表单验证]
    N --> O{验证通过？}
    O -->|是| P[调用addUser API]
    O -->|否| Q[显示验证错误]
    P --> R[保存用户信息]
    R --> S[刷新用户列表]
    S --> T[显示添加成功]
    
    H --> U[预填用户信息]
    U --> V[修改用户数据]
    V --> W[调用updateUser API]
    W --> X[更新数据库]
    X --> Y[刷新列表显示]
    
    I --> Z[显示确认删除弹窗]
    Z --> AA{用户确认？}
    AA -->|是| BB[调用deleteUser API]
    AA -->|否| CC[取消操作]
    BB --> DD[从数据库删除]
    DD --> EE[刷新用户列表]
    EE --> FF[显示删除成功]
    
    Q --> L
    
    style A fill:#e1f5fe
    style T fill:#c8e6c9
    style Y fill:#c8e6c9
    style FF fill:#c8e6c9
    style Q fill:#ffcdd2
    style CC fill:#fff3e0
```

### 2.3 角色权限配置流程

```mermaid
flowchart TD
    A[管理员访问角色配置页面] --> B[初始化页面数据]
    B --> C[调用loadRoleConfigurations]
    C --> D[调用getRoleConfigurations API]
    D --> E[获取角色配置列表]
    E --> F[Table组件渲染角色列表]
    F --> G{管理员操作类型}
    
    G -->|新增角色| H[点击新增角色配置]
    G -->|编辑角色| I[点击编辑按钮]
    G -->|复制角色| J[点击复制按钮]
    G -->|删除角色| K[点击删除按钮]
    
    H --> L[打开RoleConfigModal]
    L --> M[填写角色基本信息]
    M --> N[设置适用组织类型]
    N --> O[配置页面操作权限]
    O --> P[配置数据范围权限]
    P --> Q[提交角色配置]
    Q --> R{数据验证通过？}
    R -->|是| S[调用addRoleConfiguration API]
    R -->|否| T[显示验证错误]
    S --> U[保存角色配置]
    U --> V[刷新角色列表]
    V --> W[显示创建成功]
    
    I --> X[预加载角色配置]
    X --> Y[修改角色信息]
    Y --> Z[调用updateRoleConfiguration API]
    Z --> AA[更新数据库]
    AA --> BB[刷新显示]
    
    J --> CC[打开复制弹窗]
    CC --> DD[设置新角色名称]
    DD --> EE[调用copyRoleConfiguration API]
    EE --> FF[复制权限配置]
    FF --> GG[生成新角色]
    GG --> HH[刷新列表]
    
    K --> II{是否系统角色？}
    II -->|是| JJ[提示不允许删除]
    II -->|否| KK[显示确认删除弹窗]
    KK --> LL{用户确认？}
    LL -->|是| MM[调用deleteRoleConfiguration API]
    LL -->|否| NN[取消删除]
    MM --> OO[从数据库删除]
    OO --> PP[刷新角色列表]
    PP --> QQ[显示删除成功]
    
    T --> M
    
    style A fill:#e1f5fe
    style W fill:#c8e6c9
    style BB fill:#c8e6c9
    style HH fill:#c8e6c9
    style QQ fill:#c8e6c9
    style T fill:#ffcdd2
    style JJ fill:#ffcdd2
    style NN fill:#fff3e0
```

### 2.4 组织节点选择和数据联动流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant OT as OrgTree组件
    participant Main as 主页面组件
    participant OD as OrgDetails组件
    participant UL as UserList组件
    participant API as API服务层
    
    U->>OT: 点击组织树节点
    OT->>Main: 触发onSelect事件
    Main->>Main: 设置selectedNode状态
    
    par 并行加载组织详情和用户列表
        Main->>OD: 传入selectedNode
        OD->>OD: 渲染组织详情
    and
        Main->>API: 调用getUsersByOrgId
        API-->>Main: 返回用户列表数据
        Main->>UL: 传入users数据
        UL->>UL: 渲染用户表格
    end
    
    Note over Main: 页面状态更新完成
    
    alt 用户点击新增子组织
        U->>OD: 点击新增子组织按钮
        OD->>Main: 触发onAddOrg事件
        Main->>Main: 打开AddOrgModal
    else 用户点击添加员工
        U->>UL: 点击添加用户按钮
        UL->>Main: 触发onAddUser事件
        Main->>Main: 打开用户编辑弹窗
    end
```

### 2.5 权限控制流程

```mermaid
flowchart TD
    A[用户登录系统] --> B[获取用户角色信息]
    B --> C[加载角色权限配置]
    C --> D[解析页面操作权限]
    D --> E[解析数据范围权限]
    E --> F[用户访问组织管理页面]
    F --> G{检查页面访问权限}
    G -->|有权限| H[正常显示页面]
    G -->|无权限| I[显示权限不足提示]
    
    H --> J[用户执行具体操作]
    J --> K{检查操作权限}
    K -->|有权限| L[执行操作逻辑]
    K -->|无权限| M[禁用操作按钮]
    
    L --> N{涉及数据访问？}
    N -->|是| O[检查数据范围权限]
    N -->|否| P[直接执行操作]
    
    O --> Q{数据在权限范围内？}
    Q -->|是| R[返回数据结果]
    Q -->|否| S[过滤不可见数据]
    
    P --> T[操作执行完成]
    R --> T
    S --> T
    
    style A fill:#e1f5fe
    style T fill:#c8e6c9
    style I fill:#ffcdd2
    style M fill:#ffcdd2
```

## 3. 流程说明

### 3.1 组织架构管理流程说明

- **流程入口：** 用户访问 `/organization` 路由
- **关键节点：** 组织类型层级验证，确保组织结构的合理性
- **数据验证：** 组织名称长度、上级组织存在性、法人主体关联
- **异常处理：** 创建失败时提供明确的错误提示

### 3.2 用户人员管理流程说明

- **前置条件：** 必须先选择组织节点
- **权限控制：** 只能在有权限的组织下添加/编辑用户
- **数据关联：** 用户与组织、角色的多对一关系
- **状态同步：** 操作完成后实时刷新列表显示

### 3.3 角色权限配置流程说明

- **系统角色保护：** 系统内置角色不允许删除和关键配置修改
- **权限细粒度：** 支持页面级和数据级的权限控制
- **复制功能：** 支持基于现有角色快速创建新角色
- **生效机制：** 角色配置修改后影响所有使用该角色的用户

### 3.4 组件间通信机制

- **状态管理：** 使用React useState进行状态管理
- **事件驱动：** 通过回调函数实现组件间通信
- **数据流：** 单向数据流，父组件管理状态，子组件触发事件

## 4. 技术实现要点

### 4.1 API调用模式
- 所有API调用都有统一的错误处理机制
- 支持loading状态显示，提升用户体验
- 模拟延迟确保真实性

### 4.2 组件设计原则
- 单一职责：每个组件负责特定功能
- 可复用性：通用组件支持多场景使用
- 响应式设计：适配不同屏幕尺寸

### 4.3 状态管理策略
- 本地状态：组件内部状态使用useState
- 状态提升：共享状态提升到父组件
- 异步状态：使用useEffect处理副作用

---

**文档说明：** 本流程图文档基于 `src\pages\organization` 模块的代码实现，展示了组织架构管理、用户管理、角色配置等核心业务流程的详细步骤和交互关系。 