# 业务流程图 - 营销规则引擎系统模块v1.0

## 1. 营销规则创建配置流程

```mermaid
graph TB
    A[营销规则管理首页] --> B[点击新建规则]
    B --> C[规则类型选择页面]
    C --> D{选择营销类型}
    D -->|整单营销| E[整单直降/折扣/返券/返赠]
    D -->|明细营销-油品| F[明细折扣/直降/返券/返赠/单价锁定/充值直降]
    D -->|明细营销-非油品| G[明细折扣/直降/返券/返赠/每满折扣/每满直降/单价锁定]
    
    E --> H[基本信息配置步骤1]
    F --> H
    G --> H
    
    H --> H1[规则名称输入]
    H --> H2[活动时间设置]
    H --> H3[优惠油站选择]
    H --> H4[专车身份配置]
    H --> H5[支付方式选择]
    H --> H6[用户限制设置]
    H --> H7[优惠油品选择]
    H --> H8[重复类型配置]
    
    H1 --> I{基本信息验证}
    H2 --> I
    H3 --> I
    H4 --> I
    H5 --> I
    H6 --> I
    H7 --> I
    H8 --> I
    
    I -->|验证失败| H
    I -->|验证成功| J[优惠明细配置步骤2]
    
    J --> J1[实付金额取整方式]
    J --> J2[价格区间设置]
    J --> J3[优惠金额/折扣率]
    J --> J4[计算方式选择]
    
    J1 --> K{优惠明细验证}
    J2 --> K
    J3 --> K
    J4 --> K
    
    K -->|验证失败| J
    K -->|验证成功| L[优惠限制配置步骤3]
    
    L --> L1[积分抵油互斥设置]
    L --> L2[抵扣券共享设置]
    L --> L3[其他优惠共享设置]
    L --> L4[规则优先级设置]
    
    L1 --> M{优惠限制验证}
    L2 --> M
    L3 --> M
    L4 --> M
    
    M -->|验证失败| L
    M -->|验证成功| N[规则配置完成]
    
    N --> O{选择后续操作}
    O -->|立即测试| P[规则测试验证]
    O -->|直接保存| Q[保存规则]
    
    P --> P1[配置测试条件]
    P1 --> P2[执行规则计算]
    P2 --> P3[查看测试结果]
    P3 --> R{测试结果满意?}
    R -->|否| H
    R -->|是| Q
    
    Q --> S[规则保存成功]
    S --> T[规则状态：未开始]
    T --> U[手动启用规则]
    U --> V[规则状态：进行中]
```

## 2. 营销规则类型选择流程

```mermaid
graph LR
    A[营销引擎系统] --> B[整单营销]
    A --> C[明细营销]
    
    B --> B1[整单直降<br/>type:5]
    B --> B2[整单折扣<br/>type:6]
    B --> B3[整单返券<br/>type:7]
    B --> B4[整单返赠<br/>type:8]
    
    C --> D[油品营销]
    C --> E[非油品营销]
    
    D --> D1[明细折扣<br/>type:1]
    D --> D2[明细直降<br/>type:2]
    D --> D3[明细返券<br/>type:9]
    D --> D4[明细返赠<br/>type:10]
    D --> D5[单价锁定<br/>type:3<br/>喂通卡专享]
    D --> D6[充值直降<br/>type:4<br/>喂通卡专享]
    
    E --> E1[明细折扣<br/>type:11]
    E --> E2[明细直降<br/>type:12]
    E --> E3[明细返券<br/>type:13]
    E --> E4[明细返赠<br/>type:14]
    E --> E5[每满折扣<br/>type:17]
    E --> E6[每满直降<br/>type:16]
    E --> E7[单价锁定<br/>type:15<br/>喂通卡专享]
```

## 3. 营销规则状态管理流程

```mermaid
graph TB
    A[规则创建完成] --> B[初始状态：未开始<br/>NotStarted]
    
    B --> C{手动启用操作}
    C -->|启用| D[状态：启用<br/>RuleState:100]
    C -->|禁用| E[状态：禁用<br/>RuleState:101]
    
    D --> F{时间状态检查}
    F -->|未到开始时间| G[活动状态：未开始<br/>ActivityStatus:NotStarted]
    F -->|在有效期内| H[活动状态：进行中<br/>ActivityStatus:Active]
    F -->|超过结束时间| I[活动状态：已结束<br/>ActivityStatus:Expired]
    
    E --> J[活动状态：已禁用<br/>ActivityStatus:Disable]
    
    G --> K[定时检查]
    H --> K
    I --> K
    J --> L{管理员操作}
    
    K --> F
    
    L -->|重新启用| D
    L -->|保持禁用| J
    
    H --> M[规则生效执行]
    M --> N[客户端营销计算]
    N --> O[记录使用日志]
    O --> P[效果统计分析]
```

## 4. 营销规则测试验证流程

```mermaid
graph TB
    A[进入规则测试页面] --> B[配置测试基础条件]
    
    B --> B1[选择交易时间]
    B --> B2[选择消费油站]
    B --> B3[选择专车身份]
    B --> B4[选择支付方式]
    B --> B5[选择用户限制类型]
    
    B1 --> C{选择商品类型}
    B2 --> C
    B3 --> C
    B4 --> C
    B5 --> C
    
    C -->|油品| D[配置油品信息]
    C -->|非油品| E[配置商品信息]
    
    D --> D1[选择油品类型]
    D1 --> D2[输入数量/金额]
    D2 --> D3[获取油品单价]
    D3 --> D4[计算基础金额]
    
    E --> E1[搜索商品]
    E1 --> E2[选择商品数量]
    E2 --> E3[计算商品总价]
    
    D4 --> F[执行营销规则匹配]
    E3 --> F
    
    F --> F1[筛选适用规则]
    F1 --> F2[按优先级排序]
    F2 --> F3[执行规则计算]
    F3 --> F4[处理规则互斥]
    F4 --> F5[计算最终优惠]
    
    F5 --> G[展示测试结果]
    
    G --> G1[显示原价]
    G --> G2[显示优惠金额]
    G --> G3[显示实付金额]
    G --> G4[显示适用规则]
    
    G1 --> H{测试结果满意?}
    G2 --> H
    G3 --> H
    G4 --> H
    
    H -->|满意| I[测试通过]
    H -->|不满意| J[调整规则配置]
    
    J --> K[返回规则编辑页面]
    K --> L[修改规则参数]
    L --> A
    
    I --> M[规则验证完成]
    M --> N[可正式启用规则]
```

## 5. 营销规则查询筛选流程

```mermaid
graph TB
    A[进入规则列表页面] --> B[加载初始数据]
    
    B --> C[显示筛选条件]
    
    C --> C1[状态筛选<br/>全部/未开始/进行中/已结束]
    C --> C2[优惠类型筛选<br/>折扣/满立减/赠送等]
    C --> C3[油品类型筛选<br/>全部/油品/非油品]
    C --> C4[油站筛选<br/>全部/具体油站]
    C --> C5[关键字搜索<br/>规则名称/ID]
    
    C1 --> D{用户选择筛选条件}
    C2 --> D
    C3 --> D
    C4 --> D
    C5 --> D
    
    D --> E[构建查询条件]
    E --> F[执行数据库查询]
    F --> G[应用分页参数]
    G --> H[返回查询结果]
    
    H --> I[更新表格数据]
    I --> J[显示分页信息]
    
    J --> K{用户操作选择}
    K -->|查看详情| L[跳转规则详情页]
    K -->|编辑规则| M[跳转规则编辑页]
    K -->|启用/禁用| N[状态管理操作]
    K -->|更改筛选| D
    K -->|切换页码| O[更新分页参数]
    
    L --> P[显示规则完整信息]
    M --> Q[加载规则编辑表单]
    N --> R[更新规则状态]
    O --> F
    
    R --> S[记录操作日志]
    S --> T[刷新列表数据]
    T --> I
```

## 6. 特殊营销规则处理流程

### 6.1 一口价规则流程
```mermaid
graph TB
    A[选择单价锁定规则] --> B[限制条件检查]
    B --> C{是否喂通卡支付?}
    C -->|否| D[提示：仅支持喂通卡]
    C -->|是| E[配置基础信息]
    
    E --> F[设置锁定价格]
    F --> G[选择适用油品]
    G --> H[设置有效期]
    H --> I[验证价格合理性]
    
    I --> J{价格验证通过?}
    J -->|否| F
    J -->|是| K[保存一口价规则]
    
    K --> L[规则生效]
    L --> M[客户端价格锁定]
```

### 6.2 充值直降规则流程
```mermaid
graph TB
    A[选择充值直降规则] --> B[配置充值阈值]
    B --> C[设置优惠油品]
    C --> D[配置优惠金额]
    D --> E[设置适用条件]
    E --> F[关联充值系统]
    
    F --> G[规则生效]
    G --> H[客户充值操作]
    H --> I[检查充值金额]
    I --> J{达到阈值?}
    
    J -->|否| K[无优惠]
    J -->|是| L[计算优惠金额]
    L --> M[应用充值直降]
```

## 7. 营销规则操作日志流程

```mermaid
graph TB
    A[用户操作行为] --> B{操作类型判断}
    
    B -->|创建规则| C[记录创建日志]
    B -->|编辑规则| D[记录编辑日志]
    B -->|启用规则| E[记录启用日志]
    B -->|禁用规则| F[记录禁用日志]
    B -->|删除规则| G[记录删除日志]
    
    C --> H[收集操作信息]
    D --> H
    E --> H
    F --> H
    G --> H
    
    H --> H1[操作人员信息]
    H --> H2[操作时间戳]
    H --> H3[操作内容描述]
    H --> H4[相关规则信息]
    H --> H5[操作结果状态]
    
    H1 --> I[写入日志表]
    H2 --> I
    H3 --> I
    H4 --> I
    H5 --> I
    
    I --> J[日志记录成功]
    
    J --> K[日志查询功能]
    K --> L[筛选查询条件]
    L --> M[返回日志列表]
    M --> N[分页显示结果]
```

## 8. 营销规则计算引擎流程

```mermaid
graph TB
    A[客户端发起交易] --> B[获取交易信息]
    
    B --> B1[交易时间]
    B --> B2[消费油站]
    B --> B3[支付方式]
    B --> B4[用户信息]
    B --> B5[商品信息]
    B --> B6[交易金额]
    
    B1 --> C[查询适用规则]
    B2 --> C
    B3 --> C
    B4 --> C
    B5 --> C
    B6 --> C
    
    C --> D[规则条件匹配]
    D --> E[筛选符合条件规则]
    E --> F[按优先级排序]
    F --> G[执行规则计算]
    
    G --> G1{规则类型判断}
    G1 -->|整单营销| H[整单优惠计算]
    G1 -->|明细营销| I[明细优惠计算]
    
    H --> H1[整单直降计算]
    H --> H2[整单折扣计算]
    H --> H3[整单返券计算]
    H --> H4[整单返赠计算]
    
    I --> I1[明细折扣计算]
    I --> I2[明细直降计算]
    I --> I3[单价锁定计算]
    I --> I4[充值直降计算]
    I --> I5[每满优惠计算]
    
    H1 --> J[优惠结果汇总]
    H2 --> J
    H3 --> J
    H4 --> J
    I1 --> J
    I2 --> J
    I3 --> J
    I4 --> J
    I5 --> J
    
    J --> K[处理规则互斥]
    K --> L[应用取整方式]
    L --> M[计算最终优惠]
    M --> N[返回优惠结果]
    
    N --> O[更新交易金额]
    O --> P[记录使用日志]
    P --> Q[完成交易处理]
```

---

**流程图说明：**
1. 所有流程图使用Mermaid语法，支持在Markdown中直接渲染
2. 流程覆盖营销规则系统的完整生命周期管理
3. 特别标注了喂通卡专享功能的特殊处理流程
4. 包含了规则验证、测试、状态管理等关键业务节点
5. 营销计算引擎流程展示了规则执行的核心逻辑

**文档版本：** v1.0  
**创建日期：** 2025-08-26  
**文档状态：** 初稿