# 数据字典 - 营销规则引擎系统v1.0

## 1. 核心数据表结构

### 1.1 营销规则表 (DiscountRule)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| ID | INT | 11 | NOT NULL | AUTO_INCREMENT | 规则唯一标识 | 1001 |
| RuleName | VARCHAR | 100 | NOT NULL | - | 规则名称 | "周末加油8折优惠" |
| RuleDiscountType | TINYINT | 1 | NOT NULL | - | 优惠类型：0-折扣,1-满立减,2-赠送,3-单价锁定,4-充值直降,5-每满直降,6-每满折扣 | 0 |
| RuleStartTime | DATETIME | - | NOT NULL | - | 规则开始时间 | "2025-01-01 00:00:00" |
| RuleEndTime | DATETIME | - | NOT NULL | - | 规则结束时间 | "2025-12-31 23:59:59" |
| RuleStation | JSON | - | NULL | NULL | 适用油站列表，JSON格式存储油站ID数组 | [1001,1002,1003] |
| RuleIdentity | JSON | - | NULL | NULL | 专车身份限制，存储身份代码数组 | ["VIP","TAXI"] |
| RuleDiscountMethod | TINYINT | 1 | NULL | 2 | 商品类型：0-油品,1-非油品,2-全部 | 2 |
| RulePayMethod | JSON | - | NULL | NULL | 支付方式限制，存储支付方式编号数组 | [1,2,3] |
| RuleCardName | JSON | - | NULL | NULL | 卡名称限制，存储卡主题ID数组 | [101,102] |
| RuleCardType | JSON | - | NULL | NULL | 卡类型限制：1-个人卡,2-车队卡,3-不记名卡 | [1,2] |
| RuleCustomerType | VARCHAR | 20 | NULL | NULL | 用户限制类型：LA-会员等级,G-卡组,C-车队卡 | "LA" |
| RuleCustomerInfo | JSON | - | NULL | NULL | 用户限制详细信息，根据类型存储对应ID数组 | [1,2,3] |
| RuleOilInfo | JSON | - | NULL | NULL | 适用油品信息，存储油品ID数组 | [92,95,98] |
| RepetTime | VARCHAR | 10 | NULL | NULL | 重复类型：D-每日,W-每周,M-每月 | "W" |
| RuleDiscount | JSON | - | NOT NULL | - | 优惠规则详细配置，复杂JSON结构 | 见下文详细说明 |
| RuleEnding | TINYINT | 1 | NOT NULL | 0 | 取整方式：0-四舍五入,1-进位,2-截尾 | 0 |
| ISOilDisplacement | TINYINT | 1 | NOT NULL | 0 | 是否与积分抵油互斥：0-否,1-是 | 0 |
| ISCoupon | TINYINT | 1 | NOT NULL | 0 | 是否抵扣券共享：0-否,1-是 | 1 |
| ISDiscountShare | TINYINT | 1 | NOT NULL | 0 | 是否与其他优惠共享：0-否,1-是 | 1 |
| RulePriority | TINYINT | 2 | NOT NULL | 10 | 规则优先级：1-10，数值越小优先级越高 | 5 |
| RuleState | TINYINT | 3 | NOT NULL | 100 | 规则状态：100-启用,101-禁用 | 100 |
| ActivityStatus | VARCHAR | 20 | NOT NULL | "NotStarted" | 活动状态：NotStarted-未开始,Active-进行中,Expired-已结束,Disable-已禁用 | "Active" |
| Type | TINYINT | 1 | NULL | 1 | 规则类型标识，用于区分不同创建方式 | 1 |
| CreateTime | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | "2025-08-26 10:00:00" |
| UpdateTime | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | "2025-08-26 15:30:00" |

### 1.2 营销规则详细配置结构 (RuleDiscount JSON字段)

```json
[
  {
    "repeatTime": {
      "RepeaType": "W",
      "RepeatPeriod": [1, 2, 3, 4, 5],
      "timeRule_SJList": [
        {
          "QSSJ": "09:00:00",
          "JZSJ": "18:00:00"
        }
      ]
    },
    "calculationInterval": [
      {
        "PayMethod": [1, 2, 3],
        "oilAndGoods": [92, 95, 98],
        "Type": 0,
        "CalculationType": ">=",
        "calculation": [
          {
            "StartNum": 100.00,
            "EndNum": 200.00,
            "CalculationNum": 0.95
          },
          {
            "StartNum": 200.00,
            "EndNum": 999999.99,
            "CalculationNum": 0.90
          }
        ]
      }
    ]
  }
]
```

**RuleDiscount字段结构说明：**
- `repeatTime`: 时间重复规则配置
  - `RepeaType`: 重复类型 (D/W/M)
  - `RepeatPeriod`: 重复周期 (周几/月几号)
  - `timeRule_SJList`: 生效时间段列表
- `calculationInterval`: 计算区间配置数组
  - `PayMethod`: 适用支付方式数组
  - `oilAndGoods`: 适用油品/商品数组
  - `Type`: 计算类型 (0-按实付,5-按原价,1-按升数/数量)
  - `CalculationType`: 计算方式 (>=, <, =)
  - `calculation`: 价格区间和优惠配置数组

### 1.3 营销规则操作日志表 (RuleOperationLog)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| id | INT | 11 | NOT NULL | AUTO_INCREMENT | 日志ID | 10001 |
| rule_id | INT | 11 | NULL | NULL | 关联的规则ID | 1001 |
| oper_name | VARCHAR | 50 | NOT NULL | - | 操作人员姓名 | "张三" |
| oper_id | INT | 11 | NOT NULL | - | 操作人员ID | 2001 |
| operate | TEXT | - | NOT NULL | - | 操作内容描述 | "创建新的营销规则：周末加油8折优惠" |
| rule_type | TINYINT | 1 | NULL | NULL | 操作涉及的规则类型 | 0 |
| oil_type | TINYINT | 1 | NULL | NULL | 操作涉及的商品类型：0-油品,1-非油品,2-全部 | 0 |
| create_time | INT | 10 | NOT NULL | - | 操作时间戳 | 1692176400 |
| status | TINYINT | 1 | NOT NULL | 1 | 操作状态：1-成功,0-失败 | 1 |

### 1.4 油站基础信息表 (StationInfo)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| stid | INT | 11 | NOT NULL | - | 油站ID | 1001 |
| stname | VARCHAR | 100 | NOT NULL | - | 油站名称 | "北京朝阳加油站" |
| status | TINYINT | 1 | NOT NULL | 1 | 油站状态：1-启用,0-停用 | 1 |
| region_id | INT | 11 | NULL | NULL | 所属区域ID | 101 |
| province | VARCHAR | 50 | NULL | NULL | 省份 | "北京市" |
| city | VARCHAR | 50 | NULL | NULL | 城市 | "北京市" |
| address | VARCHAR | 200 | NULL | NULL | 详细地址 | "朝阳区建国路1号" |
| create_time | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | "2025-01-01 00:00:00" |

### 1.5 专车身份渠道表 (ChannelIdentity)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| channel_code | VARCHAR | 20 | NOT NULL | - | 身份渠道代码 | "VIP" |
| name | VARCHAR | 50 | NOT NULL | - | 身份名称 | "VIP专车" |
| description | TEXT | - | NULL | NULL | 身份描述 | "VIP用户专享身份" |
| status | TINYINT | 1 | NOT NULL | 1 | 状态：1-启用,0-停用 | 1 |

### 1.6 支付方式表 (PaymentMethod)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| BH | INT | 11 | NOT NULL | - | 支付方式编号 | 1 |
| MC | VARCHAR | 50 | NOT NULL | - | 支付方式名称 | "加油卡" |
| type | TINYINT | 1 | NOT NULL | - | 支付类型：1-卡类支付,2-现金,3-第三方支付 | 1 |
| status | TINYINT | 1 | NOT NULL | 1 | 状态：1-启用,0-停用 | 1 |

### 1.7 油品信息表 (OilInfo)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| oil_id | INT | 11 | NOT NULL | - | 油品ID | 92 |
| oil_name | VARCHAR | 50 | NOT NULL | - | 油品名称 | "92#汽油" |
| oil_type | TINYINT | 1 | NOT NULL | - | 油品类型：1-汽油,2-柴油,3-其他 | 1 |
| unit | VARCHAR | 10 | NOT NULL | "升" | 计量单位 | "升" |
| status | TINYINT | 1 | NOT NULL | 1 | 状态：1-启用,0-停用 | 1 |

### 1.8 卡主题表 (CardTheme)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| ID | INT | 11 | NOT NULL | AUTO_INCREMENT | 卡主题ID | 101 |
| Name | VARCHAR | 100 | NOT NULL | - | 卡主题名称 | "喂通卡标准版" |
| Type | TINYINT | 1 | NOT NULL | - | 卡类型：1-个人卡,2-车队卡,3-不记名卡 | 1 |
| status | TINYINT | 1 | NOT NULL | 1 | 状态：1-启用,0-停用 | 1 |

### 1.9 会员等级表 (MemberLevel)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| id | INT | 11 | NOT NULL | AUTO_INCREMENT | 等级ID | 1 |
| level_name | VARCHAR | 50 | NOT NULL | - | 等级名称 | "黄金会员" |
| level_code | VARCHAR | 20 | NOT NULL | - | 等级代码 | "GOLD" |
| min_points | INT | 11 | NOT NULL | 0 | 最低积分要求 | 1000 |
| max_points | INT | 11 | NULL | NULL | 最高积分上限 | 4999 |
| status | TINYINT | 1 | NOT NULL | 1 | 状态：1-启用,0-停用 | 1 |

### 1.10 客户卡组表 (CustomerGroup)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| ID | INT | 11 | NOT NULL | AUTO_INCREMENT | 卡组ID | 201 |
| CustomerGroupName | VARCHAR | 100 | NOT NULL | - | 卡组名称 | "企业客户卡组A" |
| Description | TEXT | - | NULL | NULL | 卡组描述 | "企业大客户专用卡组" |
| status | TINYINT | 1 | NOT NULL | 1 | 状态：1-启用,0-停用 | 1 |

### 1.11 车队卡信息表 (CompanyCard)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 字段说明 | 示例值 |
|--------|----------|------|----------|--------|----------|--------|
| ID | INT | 11 | NOT NULL | AUTO_INCREMENT | 车队卡ID | 301 |
| CompanyName | VARCHAR | 100 | NOT NULL | - | 车队公司名称 | "北京运输有限公司" |
| ContactName | VARCHAR | 50 | NULL | NULL | 联系人姓名 | "李经理" |
| ContactPhone | VARCHAR | 20 | NULL | NULL | 联系电话 | "13800138000" |
| status | TINYINT | 1 | NOT NULL | 1 | 状态：1-启用,0-停用 | 1 |

## 2. 枚举值定义

### 2.1 营销规则类型枚举 (RuleDiscountType)

| 枚举值 | 名称 | 说明 | 适用场景 |
|--------|------|------|----------|
| 0 | 折扣 | 按比例折扣优惠 | 明细营销和整单营销 |
| 1 | 满立减 | 满额直降优惠 | 明细营销和整单营销 |
| 2 | 赠送 | 满额赠送商品 | 明细营销和整单营销 |
| 3 | 单价锁定 | 锁定商品单价 | 喂通卡专享，油品和非油品 |
| 4 | 充值直降 | 基于充值的优惠 | 喂通卡专享，油品 |
| 5 | 每满直降 | 每满指定金额直降 | 非油品营销 |
| 6 | 每满折扣 | 每满指定金额折扣 | 非油品营销 |

### 2.2 规则状态枚举 (RuleState)

| 枚举值 | 名称 | 说明 |
|--------|------|------|
| 100 | 启用 | 规则已启用，可以参与营销计算 |
| 101 | 禁用 | 规则已禁用，不参与营销计算 |

### 2.3 活动状态枚举 (ActivityStatus)

| 枚举值 | 名称 | 说明 |
|--------|------|------|
| NotStarted | 未开始 | 活动还未到开始时间 |
| Active | 进行中 | 活动正在进行中 |
| Expired | 已结束 | 活动已过结束时间 |
| Disable | 已禁用 | 活动被手动禁用 |

### 2.4 商品类型枚举 (RuleDiscountMethod)

| 枚举值 | 名称 | 说明 |
|--------|------|------|
| 0 | 油品 | 仅适用于油品商品 |
| 1 | 非油品 | 仅适用于非油品商品 |
| 2 | 全部 | 适用于所有商品类型 |

### 2.5 计算类型枚举 (Type)

| 枚举值 | 名称 | 说明 | 单位 |
|--------|------|------|------|
| 0 | 按实付 | 按实际支付金额计算 | 元 |
| 5 | 按原价 | 按商品原价计算 | 元 |
| 1 | 按升数/数量 | 按油品升数或商品数量计算 | 升/件 |

### 2.6 取整方式枚举 (RuleEnding)

| 枚举值 | 名称 | 说明 | 示例 |
|--------|------|------|------|
| 0 | 四舍五入 | 按四舍五入规则取整到分 | 24.336 → 24.34 |
| 1 | 进位 | 向上取整到元 | 24.336 → 25.00 |
| 2 | 截尾 | 向下取整到元 | 24.336 → 24.00 |

### 2.7 重复类型枚举 (RepetTime)

| 枚举值 | 名称 | 说明 |
|--------|------|------|
| D | 每日 | 每天重复执行 |
| W | 每周 | 每周指定日期重复执行 |
| M | 每月 | 每月指定日期重复执行 |

### 2.8 用户限制类型枚举 (RuleCustomerType)

| 枚举值 | 名称 | 说明 |
|--------|------|------|
| LA | 会员等级 | 按会员等级限制 |
| G | 卡组 | 按客户卡组限制 |
| C | 车队卡 | 按车队卡限制 |

### 2.9 卡类型枚举 (CardType)

| 枚举值 | 名称 | 说明 |
|--------|------|------|
| 1 | 个人卡 | 个人用户使用的卡 |
| 2 | 车队卡 | 车队企业使用的卡 |
| 3 | 不记名卡 | 不记名的通用卡 |

## 3. 业务规则与约束

### 3.1 数据完整性约束

1. **规则名称唯一性**: 同一时间段内，规则名称不能重复
2. **时间逻辑约束**: RuleStartTime < RuleEndTime
3. **价格区间约束**: 在calculation数组中，StartNum < EndNum，且区间不能重叠
4. **优先级约束**: RulePriority范围为1-10，且数值越小优先级越高
5. **状态转换约束**: 只有启用状态的规则才能参与营销计算

### 3.2 业务逻辑约束

1. **喂通卡专享**: 单价锁定(type 3)和充值直降(type 4)仅支持喂通卡支付方式
2. **合并支付限制**: 合并支付只能使用整单营销规则(type 5,6,7,8)
3. **规则互斥**: 根据ISOilDisplacement、ISCoupon、ISDiscountShare字段控制规则间的互斥关系
4. **时间段限制**: 每个规则最多支持5个时间段配置
5. **阶梯计算**: 价格区间支持多阶梯配置，按StartNum升序排列

### 3.3 数据格式约束

1. **JSON字段格式**: RuleDiscount、RuleStation等JSON字段必须符合预定义的结构
2. **数值精度**: 金额字段保留2位小数，优惠比例保留4位小数
3. **时间格式**: 时间字段统一使用"YYYY-MM-DD HH:mm:ss"格式
4. **编码格式**: 所有文本字段使用UTF-8编码

## 4. 索引设计建议

### 4.1 主要索引

```sql
-- 营销规则表索引
CREATE INDEX idx_rule_status ON DiscountRule(RuleState, ActivityStatus);
CREATE INDEX idx_rule_time ON DiscountRule(RuleStartTime, RuleEndTime);
CREATE INDEX idx_rule_type ON DiscountRule(RuleDiscountType, RuleDiscountMethod);
CREATE INDEX idx_rule_priority ON DiscountRule(RulePriority);
CREATE INDEX idx_rule_station ON DiscountRule(RuleStation(100));

-- 操作日志表索引
CREATE INDEX idx_log_time ON RuleOperationLog(create_time);
CREATE INDEX idx_log_rule ON RuleOperationLog(rule_id);
CREATE INDEX idx_log_oper ON RuleOperationLog(oper_id);
CREATE INDEX idx_log_type ON RuleOperationLog(rule_type, oil_type);
```

### 4.2 复合索引

```sql
-- 规则查询复合索引
CREATE INDEX idx_rule_query ON DiscountRule(RuleState, ActivityStatus, RuleDiscountType, RuleStartTime);

-- 日志查询复合索引
CREATE INDEX idx_log_query ON RuleOperationLog(rule_type, oil_type, create_time);
```

## 5. 数据迁移与维护

### 5.1 数据清理策略

1. **历史日志**: 操作日志保留1年，超过时间的记录可归档或删除
2. **过期规则**: 已结束超过6个月的规则可标记为历史数据
3. **测试数据**: 定期清理测试环境的规则数据

### 5.2 数据备份策略

1. **增量备份**: 每日备份当天变更的规则数据
2. **全量备份**: 每周进行全量数据备份
3. **关键节点**: 在重大营销活动前后进行专项备份

---

**数据字典说明：**
1. 本数据字典基于营销规则引擎系统的完整分析
2. 包含了17种营销规则类型的完整数据结构
3. 特别考虑了喂通卡专享功能的数据需求
4. 提供了完整的枚举值定义和业务约束
5. 索引设计考虑了查询性能优化需求

**文档版本：** v1.0  
**创建日期：** 2025-08-26  
**文档状态：** 初稿