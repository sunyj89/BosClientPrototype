# 业务流程图文档 - 安全卫士系统模块

**版本号**: v1.1  
**日期**: 2025年8月21日

## 1. 系统总体业务流程

```mermaid
graph TD
    A[用户登录] --> B{权限验证}
    B -->|平台管理员| C[系统管理功能]
    B -->|集团管理员| D[集团管理功能]
    B -->|油站管理员| E[油站管理功能]
    B -->|现场巡检员| F[移动端巡检]
    
    C --> G[模板配置管理]
    C --> H[用户权限管理]
    D --> I[集团巡检配置]
    E --> J[油站巡检计划]
    F --> K[现场巡检执行]
    
    G --> L[巡检执行]
    I --> L
    J --> L
    K --> M[异常处理]
    L --> N[数据统计分析]
    M --> O[工单管理]
    N --> P[报表导出]
```

## 2. 用户认证与权限管理流程

### 2.1 登录认证流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant APP as 客户端
    participant API as 认证接口
    participant DB as 数据库
    participant CACHE as 缓存系统

    U->>APP: 输入用户名密码
    APP->>API: POST /login 请求
    API->>DB: 验证用户凭证
    DB-->>API: 返回用户信息
    API->>DB: 查询用户权限
    DB-->>API: 返回权限列表
    API->>CACHE: 存储会话信息
    API-->>APP: 返回登录成功+权限
    APP-->>U: 跳转到主界面
```

### 2.2 权限验证流程

```mermaid
graph TD
    A[用户访问功能] --> B{检查登录状态}
    B -->|未登录| C[跳转登录页面]
    B -->|已登录| D{检查功能权限}
    D -->|无权限| E[显示权限错误]
    D -->|有权限| F{检查数据权限}
    F -->|无权限| G[显示数据权限错误]
    F -->|有权限| H[允许访问]
    
    H --> I{权限级别判断}
    I -->|authority <= 2| J[平台级权限]
    I -->|authority = 2| K[集团级权限]
    I -->|authority > 2| L[油站级权限]
```

## 3. 巡检管理核心业务流程

### 3.1 巡检配置到执行完整流程

```mermaid
graph TD
    A[管理员登录] --> B[选择管理油站]
    B --> C[创建巡检模板]
    C --> D[定义巡检项目]
    D --> E[配置反馈标准]
    E --> F[设置巡检计划]
    F --> G[配置点位标签]
    G --> H[分配巡检任务]
    
    H --> I[巡检员接收任务]
    I --> J[到达巡检点位]
    J --> K[扫描二维码]
    K --> L[获取巡检清单]
    L --> M[执行巡检检查]
    M --> N{发现异常?}
    
    N -->|是| O[记录异常情况]
    N -->|否| P[记录正常结果]
    O --> Q[拍照取证]
    P --> R[继续下一项]
    Q --> S[提交异常报告]
    R --> T{所有项目完成?}
    T -->|否| M
    T -->|是| U[提交巡检报告]
    S --> V[系统生成工单]
    U --> W[更新任务状态]
    V --> X[通知责任人]
```

### 3.2 移动端巡检执行详细流程

```mermaid
sequenceDiagram
    participant Inspector as 巡检员
    participant MobileApp as 移动APP
    participant API as 巡检API
    participant QR as 二维码系统
    participant Storage as 文件存储
    participant DB as 数据库

    Inspector->>MobileApp: 启动巡检任务
    MobileApp->>API: 获取巡检任务列表
    API->>DB: 查询待执行任务
    DB-->>API: 返回任务详情
    API-->>MobileApp: 返回任务列表
    
    Inspector->>MobileApp: 选择巡检任务
    Inspector->>QR: 扫描点位二维码
    QR-->>MobileApp: 返回标签信息
    MobileApp->>API: 获取标签巡检配置
    API->>DB: 查询巡检项目
    DB-->>API: 返回巡检清单
    API-->>MobileApp: 返回巡检项目
    
    Inspector->>MobileApp: 执行巡检检查
    Inspector->>MobileApp: 拍照上传
    MobileApp->>Storage: 上传照片文件
    Storage-->>MobileApp: 返回文件URL
    Inspector->>MobileApp: 填写检查结果
    MobileApp->>API: 提交巡检结果
    API->>DB: 保存巡检记录
    
    alt 发现异常
        API->>DB: 创建异常记录
        API->>DB: 自动生成工单
        API->>MobileApp: 推送工单通知
    end
    
    API-->>MobileApp: 返回提交成功
    MobileApp-->>Inspector: 显示完成状态
```

## 4. 异常工单管理流程

### 4.1 工单生命周期流程

```mermaid
stateDiagram-v2
    [*] --> 待分配: 巡检异常自动生成
    待分配 --> 待处理: 分配责任人
    待处理 --> 处理中: 责任人接受
    待处理 --> 已拒绝: 责任人拒绝
    已拒绝 --> 待分配: 重新分配
    处理中 --> 待审核: 提交处理结果
    待审核 --> 已完成: 审核通过
    待审核 --> 处理中: 审核退回
    已完成 --> [*]
    
    待分配: 系统自动创建\n等待管理员分配
    待处理: 已分配责任人\n等待接受处理
    处理中: 责任人处理中\n可更新进度
    待审核: 处理完成\n等待管理员审核
    已完成: 审核通过\n工单关闭
    已拒绝: 拒绝处理\n需重新分配
```

### 4.2 工单处理详细流程

```mermaid
sequenceDiagram
    participant System as 系统
    participant Inspector as 巡检员
    participant Manager as 管理员
    participant Handler as 处理人
    participant Auditor as 审核人

    Inspector->>System: 提交巡检异常
    System->>System: 自动生成工单
    System->>Manager: 通知新工单
    
    Manager->>System: 查看工单详情
    Manager->>System: 分配处理人
    System->>Handler: 发送工单通知
    
    Handler->>System: 查看工单
    alt 接受处理
        Handler->>System: 更新状态为"处理中"
        Handler->>System: 现场处理
        Handler->>System: 上传处理照片
        Handler->>System: 提交处理结果
        System->>Auditor: 通知审核
    else 拒绝处理
        Handler->>System: 拒绝工单并说明理由
        System->>Manager: 通知拒绝
        Manager->>System: 重新分配
    end
    
    Auditor->>System: 审核处理结果
    alt 审核通过
        Auditor->>System: 确认完成
        System->>System: 工单关闭
        System->>Handler: 通知完成
    else 审核不通过
        Auditor->>System: 退回重新处理
        System->>Handler: 通知重新处理
    end
```

## 5. 配置管理流程

### 5.1 巡检模板配置流程

```mermaid
graph TD
    A[管理员创建模板] --> B[设置模板名称]
    B --> C[选择适用范围]
    C --> D[添加检查项目]
    D --> E[设置反馈类型]
    E --> F{反馈类型判断}
    
    F -->|选择题| G[配置选项内容]
    F -->|数值型| H[设置数值范围]
    F -->|图片型| I[设置拍照要求]
    F -->|文本型| J[设置输入规则]
    
    G --> K[设置异常标准]
    H --> K
    I --> K
    J --> K
    
    K --> L[保存模板配置]
    L --> M[模板生效]
    M --> N[关联到巡检计划]
```

### 5.2 标签与点位配置流程

```mermaid
graph TD
    A[添加点位信息] --> B[设置点位坐标]
    B --> C[配置设备信息]
    C --> D[生成二维码标签]
    D --> E[设置8位标签编码]
    E --> F[关联巡检模板]
    F --> G[配置巡检项目]
    G --> H[设置检查频率]
    H --> I[保存标签配置]
    I --> J[打印二维码]
    J --> K[现场张贴标签]
    K --> L[标签验证测试]
    L --> M{测试通过?}
    M -->|是| N[标签生效]
    M -->|否| O[修正配置]
    O --> I
```

## 6. 数据管理与统计流程

### 6.1 数据统计分析流程

```mermaid
graph TD
    A[选择统计维度] --> B{统计类型}
    B -->|巡检完成率| C[按时间/油站统计]
    B -->|异常分析| D[按异常类型统计]
    B -->|工单处理| E[按处理状态统计]
    
    C --> F[查询巡检记录]
    D --> G[查询异常记录]
    E --> H[查询工单记录]
    
    F --> I[计算完成率]
    G --> J[统计异常分布]
    H --> K[分析处理效率]
    
    I --> L[生成统计报表]
    J --> L
    K --> L
    
    L --> M[图表展示]
    M --> N[支持导出Excel]
    N --> O[支持打印报表]
```

## 7. 系统集成与接口流程

### 7.1 第三方系统集成流程

```mermaid
sequenceDiagram
    participant SafeGuard as 安全卫士系统
    participant ThirdParty as 第三方系统
    participant Sync as 同步服务
    participant DB as 本地数据库

    Note over SafeGuard,ThirdParty: 用户数据同步
    Sync->>ThirdParty: 请求用户数据
    ThirdParty-->>Sync: 返回用户信息
    Sync->>DB: 更新本地用户
    
    Note over SafeGuard,ThirdParty: 组织架构同步
    Sync->>ThirdParty: 请求组织数据
    ThirdParty-->>Sync: 返回组织架构
    Sync->>DB: 更新组织关系
    
    Note over SafeGuard,ThirdParty: 权限数据同步
    Sync->>ThirdParty: 请求权限数据
    ThirdParty-->>Sync: 返回权限信息
    Sync->>DB: 更新权限配置
```

### 7.2 移动端与后台数据同步

```mermaid
graph TD
    A[移动端数据变更] --> B[检查网络状态]
    B --> C{网络可用?}
    C -->|是| D[立即同步到服务器]
    C -->|否| E[存储到本地队列]
    
    D --> F[服务器处理数据]
    E --> G[等待网络恢复]
    G --> H[批量同步数据]
    
    F --> I[返回同步结果]
    H --> I
    I --> J{同步成功?}
    J -->|是| K[更新本地状态]
    J -->|否| L[加入重试队列]
    L --> M[延时重试]
    M --> D
```

---

*文档版本：v1.1*  
*创建日期：2025年8月21日*  
*文档状态：已完成*