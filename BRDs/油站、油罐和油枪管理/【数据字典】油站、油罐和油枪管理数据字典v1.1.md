# 数据字典 - 油站、油罐和油枪管理系统

**文档版本：** v1.1  
**日期：** 2025年7月16日  
**创建人：** 孙杨竣@喂车科技  

---

## 1. 数据字典概述

本数据字典定义了油站、油罐和油枪管理系统中的所有数据表结构、字段定义、数据类型、约束条件等技术规范。所有表结构设计遵循数据库设计规范，确保数据的完整性、一致性和性能。

### 1.1 命名规范

- **表名规范：** 使用下划线分隔的小写字母，如 `gas_station`
- **字段名规范：** 使用下划线分隔的小写字母，如 `station_code`
- **索引命名：** `idx_表名_字段名`，如 `idx_gas_station_code`
- **外键命名：** `fk_表名_关联表名`，如 `fk_station_branch`

### 1.2 数据类型说明

- **VARCHAR(n)：** 可变长度字符串，n为最大长度
- **CHAR(n)：** 固定长度字符串
- **TEXT：** 长文本类型
- **INT：** 32位整数
- **BIGINT：** 64位整数  
- **DECIMAL(m,n)：** 精确数值类型，m为总位数，n为小数位数
- **DATETIME：** 日期时间类型
- **ENUM：** 枚举类型
- **JSON：** JSON数据类型

---

## 2. 核心数据表设计

### 2.1 油站信息表 (gas_station)

**表描述：** 存储加油站的基本信息和配置数据

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 主键 | 外键 | 索引 | 说明 |
|--------|---------|------|----------|--------|------|------|------|------|
| id | VARCHAR | 32 | NO | - | ✓ | - | PK | 油站主键ID |
| station_code | VARCHAR | 20 | NO | - | - | - | UNI | 油站编号（业务唯一） |
| station_name | VARCHAR | 100 | NO | - | - | - | IDX | 油站名称 |
| station_type | ENUM | - | NO | '高速站' | - | - | IDX | 油站类型 |
| legal_entity | VARCHAR | 50 | NO | - | - | - | IDX | 所属法人主体 |
| branch_id | VARCHAR | 32 | NO | - | - | FK | IDX | 所属分公司ID |
| branch_name | VARCHAR | 100 | NO | - | - | - | - | 所属分公司名称 |
| service_area_id | VARCHAR | 32 | YES | NULL | - | FK | IDX | 所属服务区ID |
| service_area_name | VARCHAR | 100 | YES | NULL | - | - | - | 所属服务区名称 |
| address | VARCHAR | 200 | NO | - | - | - | - | 油站详细地址 |
| coordinates | VARCHAR | 50 | YES | NULL | - | - | - | GPS坐标(BD09) |
| order_number | INT | - | YES | NULL | - | - | IDX | 排序序号 |
| third_party_code | VARCHAR | 50 | YES | NULL | - | - | IDX | 第三方系统编号 |
| online_code | VARCHAR | 50 | YES | NULL | - | - | IDX | 线上平台编号 |
| contact_person | VARCHAR | 50 | NO | - | - | - | - | 联系人姓名 |
| contact_phone | VARCHAR | 20 | YES | NULL | - | - | - | 联系电话 |
| status | ENUM | - | NO | '正常' | - | - | IDX | 油站状态 |
| open_date | DATE | - | YES | NULL | - | - | - | 开业日期 |
| oil_guns_count | INT | - | YES | 0 | - | - | - | 加油枪数量 |
| tank_count | INT | - | YES | 0 | - | - | - | 油罐数量 |
| employees_count | INT | - | YES | 0 | - | - | - | 员工数量 |
| oil_types | JSON | - | YES | NULL | - | - | - | 支持的油品类型列表 |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 更新时间 |
| created_by | VARCHAR | 32 | NO | - | - | FK | - | 创建人ID |
| updated_by | VARCHAR | 32 | NO | - | - | FK | - | 更新人ID |

**枚举值定义：**
- station_type: ('高速站', '城市站', '农村站')
- status: ('正常', '维护中', '停业', '建设中')

**索引定义：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_station_code (station_code)
- INDEX idx_station_name (station_name)
- INDEX idx_branch_id (branch_id)
- INDEX idx_status (status)
- INDEX idx_create_time (create_time)

**约束条件：**
- station_code 格式：8位数字编码
- coordinates 格式：经度,纬度（如：115.892151,28.676493）
- contact_phone 格式：手机号码校验

### 2.2 油罐信息表 (oil_tank)

**表描述：** 存储油罐设备的详细配置和技术参数

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 主键 | 外键 | 索引 | 说明 |
|--------|---------|------|----------|--------|------|------|------|------|
| id | VARCHAR | 32 | NO | - | ✓ | - | PK | 油罐主键ID |
| tank_code | VARCHAR | 20 | NO | - | - | - | UNI | 油罐编号（业务唯一） |
| tank_name | VARCHAR | 100 | NO | - | - | - | IDX | 油罐名称 |
| station_id | VARCHAR | 32 | NO | - | - | FK | IDX | 所属油站ID |
| station_code | VARCHAR | 20 | NO | - | - | - | IDX | 所属油站编号 |
| station_name | VARCHAR | 100 | NO | - | - | - | - | 所属油站名称 |
| branch_id | VARCHAR | 32 | NO | - | - | FK | IDX | 所属分公司ID |
| branch_name | VARCHAR | 100 | NO | - | - | - | - | 所属分公司名称 |
| oil_type | VARCHAR | 20 | NO | - | - | - | IDX | 油品类型 |
| oil_type_code | VARCHAR | 10 | NO | - | - | FK | IDX | 油品类型编码 |
| max_capacity | DECIMAL | 12,2 | NO | - | - | - | - | 最大罐容(升) |
| design_capacity | DECIMAL | 12,2 | NO | - | - | - | - | 设计罐容(升) |
| current_volume | DECIMAL | 12,2 | YES | 0.00 | - | - | - | 当前存量(升) |
| associated_guns | JSON | - | YES | NULL | - | - | - | 关联油枪列表 |
| default_density | DECIMAL | 6,3 | NO | - | - | - | - | 默认密度(g/ml) |
| level_meter_interface | ENUM | - | NO | '串口' | - | - | - | 液位仪接口类型 |
| baud_rate | INT | - | YES | NULL | - | - | - | 波特率(Hz) |
| level_meter_brand | VARCHAR | 50 | NO | - | - | - | - | 液位仪品牌 |
| tank_capacity_table_file | VARCHAR | 200 | YES | NULL | - | - | - | 容积表文件路径 |
| thresholds | JSON | - | YES | NULL | - | - | - | 阈值配置参数 |
| status | ENUM | - | NO | '正常' | - | - | IDX | 设备状态 |
| install_date | DATE | - | YES | NULL | - | - | - | 安装日期 |
| last_inspection | DATE | - | YES | NULL | - | - | - | 最近检查日期 |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 更新时间 |
| created_by | VARCHAR | 32 | NO | - | - | FK | - | 创建人ID |
| updated_by | VARCHAR | 32 | NO | - | - | FK | - | 更新人ID |

**枚举值定义：**
- level_meter_interface: ('串口', '网口')
- status: ('正常', '维护中', '停用')

**JSON字段结构：**

thresholds 字段结构：
```json
{
  "min_level_alarm": 10,         // 最低液位告警(cm)
  "min_level_deviation": 2,      // 最低液位偏差(cm)
  "max_level_alarm": 320,        // 最高液位告警(cm)
  "max_level_deviation": 5,      // 最高液位偏差(cm)
  "water_level_alarm": 5,        // 水高告警(cm)
  "water_level_deviation": 1     // 水高偏差(cm)
}
```

**索引定义：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_tank_code (tank_code)
- INDEX idx_tank_name (tank_name)
- INDEX idx_station_id (station_id)
- INDEX idx_oil_type (oil_type)
- INDEX idx_status (status)

**约束条件：**
- tank_code 格式：油站编号前4位 + "TANK" + 3位流水号
- design_capacity ≤ max_capacity
- default_density 范围：0.001 - 2.000

### 2.3 油枪信息表 (oil_gun)

**表描述：** 存储油枪设备的配置信息和V-Hub集线器参数

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 主键 | 外键 | 索引 | 说明 |
|--------|---------|------|----------|--------|------|------|------|------|
| id | VARCHAR | 32 | NO | - | ✓ | - | PK | 油枪主键ID |
| gun_code | VARCHAR | 20 | NO | - | - | - | UNI | 油枪编号（业务唯一） |
| gun_name | VARCHAR | 100 | NO | - | - | - | IDX | 油枪名称 |
| station_id | VARCHAR | 32 | NO | - | - | FK | IDX | 所属油站ID |
| station_code | VARCHAR | 20 | NO | - | - | - | IDX | 所属油站编号 |
| station_name | VARCHAR | 100 | NO | - | - | - | - | 所属油站名称 |
| branch_id | VARCHAR | 32 | NO | - | - | FK | IDX | 所属分公司ID |
| branch_name | VARCHAR | 100 | NO | - | - | - | - | 所属分公司名称 |
| pos_display_id | INT | - | NO | - | - | - | IDX | POS显示ID |
| tank_id | VARCHAR | 32 | NO | - | - | FK | IDX | 关联油罐ID |
| tank_code | VARCHAR | 20 | NO | - | - | - | IDX | 关联油罐编号 |
| tank_name | VARCHAR | 100 | NO | - | - | - | - | 关联油罐名称 |
| oil_type | VARCHAR | 20 | NO | - | - | - | IDX | 油品类型 |
| oil_type_code | VARCHAR | 10 | NO | - | - | FK | IDX | 油品类型编码 |
| device_code | VARCHAR | 20 | NO | - | - | FK | IDX | 关联加油机编号 |
| device_name | VARCHAR | 100 | NO | - | - | - | - | 关联加油机名称 |
| status | ENUM | - | NO | '正常' | - | - | IDX | 油枪状态 |
| install_date | DATE | - | YES | NULL | - | - | - | 安装日期 |
| last_maintenance | DATE | - | YES | NULL | - | - | - | 最近维护日期 |
| vhub_config | JSON | - | YES | NULL | - | - | - | V-Hub集线器配置 |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 更新时间 |
| created_by | VARCHAR | 32 | NO | - | - | FK | - | 创建人ID |
| updated_by | VARCHAR | 32 | NO | - | - | FK | - | 更新人ID |

**枚举值定义：**
- status: ('正常', '维修中', '停用')

**JSON字段结构：**

vhub_config 字段结构：
```json
{
  "channel_number": 1,           // 通道号
  "mainboard_code": "MB001",     // 主板编号
  "hub_serial_port": "COM1",     // 串口端口
  "hub_port_number": "PORT1",    // 端口号
  "connection_type": "直连",      // 连接方式(直连/侦听)
  "pump_code_millions": 0,       // 泵码数百万位数值
  "current_status": "在线"       // 当前状态(在线/离线)
}
```

**索引定义：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_gun_code (gun_code)
- UNIQUE KEY uk_station_pos_id (station_id, pos_display_id)
- INDEX idx_gun_name (gun_name)
- INDEX idx_station_id (station_id)
- INDEX idx_tank_id (tank_id)
- INDEX idx_oil_type (oil_type)
- INDEX idx_status (status)

**约束条件：**
- gun_code 格式：油站编号前4位 + "GUN" + 3位流水号
- pos_display_id 在同一油站内唯一
- vhub_config.channel_number 在同一油站内唯一

### 2.4 设备变更记录表 (equipment_change_record)

**表描述：** 记录所有设备信息的变更历史和审批状态

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 主键 | 外键 | 索引 | 说明 |
|--------|---------|------|----------|--------|------|------|------|------|
| id | VARCHAR | 32 | NO | - | ✓ | - | PK | 记录主键ID |
| record_code | VARCHAR | 30 | NO | - | - | - | UNI | 变更记录编号 |
| object_id | VARCHAR | 32 | NO | - | - | - | IDX | 被变更对象ID |
| object_type | ENUM | - | NO | - | - | - | IDX | 对象类型 |
| object_code | VARCHAR | 20 | NO | - | - | - | IDX | 对象业务编号 |
| object_name | VARCHAR | 100 | NO | - | - | - | IDX | 对象名称 |
| station_id | VARCHAR | 32 | NO | - | - | FK | IDX | 关联油站ID |
| station_name | VARCHAR | 100 | NO | - | - | - | - | 关联油站名称 |
| operation_type | ENUM | - | NO | - | - | - | IDX | 操作类型 |
| operation_description | VARCHAR | 500 | NO | - | - | - | - | 操作描述 |
| change_content | JSON | - | YES | NULL | - | - | - | 详细变更内容 |
| change_reason | VARCHAR | 200 | YES | NULL | - | - | - | 变更原因 |
| operator_id | VARCHAR | 32 | NO | - | - | FK | IDX | 操作人ID |
| operator_name | VARCHAR | 50 | NO | - | - | - | IDX | 操作人姓名 |
| operate_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 操作时间 |
| approval_status | ENUM | - | NO | '待审批' | - | - | IDX | 审批状态 |
| approver_id | VARCHAR | 32 | YES | NULL | - | FK | IDX | 审批人ID |
| approver_name | VARCHAR | 50 | YES | NULL | - | - | - | 审批人姓名 |
| approval_time | DATETIME | - | YES | NULL | - | - | IDX | 审批时间 |
| approval_remark | TEXT | - | YES | NULL | - | - | - | 审批备注 |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP | - | - | IDX | 更新时间 |

**枚举值定义：**
- object_type: ('油站', '油罐', '油枪')
- operation_type: ('新增', '编辑', '删除', '维护', '状态变更')
- approval_status: ('待审批', '审批中', '已审批', '已驳回')

**JSON字段结构：**

change_content 字段结构：
```json
{
  "before": {                    // 变更前数据
    "field_name": "old_value"
  },
  "after": {                     // 变更后数据
    "field_name": "new_value"
  },
  "changed_fields": [            // 变更字段列表
    "field_name1",
    "field_name2"
  ]
}
```

**索引定义：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_record_code (record_code)
- INDEX idx_object_id (object_id)
- INDEX idx_object_type (object_type)
- INDEX idx_station_id (station_id)
- INDEX idx_operation_type (operation_type)
- INDEX idx_approval_status (approval_status)
- INDEX idx_operate_time (operate_time)

### 2.5 油品主数据关联表 (oil_type_ref)

**表描述：** 关联现有油品主数据系统的油品类型信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 主键 | 外键 | 索引 | 说明 |
|--------|---------|------|----------|--------|------|------|------|------|
| oil_type_code | VARCHAR | 10 | NO | - | ✓ | - | PK | 油品类型编码 |
| oil_type_name | VARCHAR | 20 | NO | - | - | - | IDX | 油品类型名称 |
| default_density | DECIMAL | 6,3 | NO | - | - | - | - | 默认密度值 |
| status | ENUM | - | NO | '有效' | - | - | IDX | 状态 |

**枚举值定义：**
- status: ('有效', '停用')

---

## 3. 关联关系设计

### 3.1 外键约束

```sql
-- 油站表外键
ALTER TABLE gas_station 
ADD CONSTRAINT fk_station_branch FOREIGN KEY (branch_id) REFERENCES organization(id);

-- 油罐表外键
ALTER TABLE oil_tank 
ADD CONSTRAINT fk_tank_station FOREIGN KEY (station_id) REFERENCES gas_station(id),
ADD CONSTRAINT fk_tank_oil_type FOREIGN KEY (oil_type_code) REFERENCES oil_type_ref(oil_type_code);

-- 油枪表外键
ALTER TABLE oil_gun 
ADD CONSTRAINT fk_gun_station FOREIGN KEY (station_id) REFERENCES gas_station(id),
ADD CONSTRAINT fk_gun_tank FOREIGN KEY (tank_id) REFERENCES oil_tank(id),
ADD CONSTRAINT fk_gun_oil_type FOREIGN KEY (oil_type_code) REFERENCES oil_type_ref(oil_type_code);

-- 变更记录表外键
ALTER TABLE equipment_change_record 
ADD CONSTRAINT fk_record_station FOREIGN KEY (station_id) REFERENCES gas_station(id);
```

### 3.2 触发器设计

#### 3.2.1 自动更新时间戳触发器

```sql
-- 创建通用的更新时间触发器
DELIMITER $$
CREATE TRIGGER tr_gas_station_update 
BEFORE UPDATE ON gas_station
FOR EACH ROW 
BEGIN
    SET NEW.update_time = CURRENT_TIMESTAMP;
END$$

CREATE TRIGGER tr_oil_tank_update 
BEFORE UPDATE ON oil_tank
FOR EACH ROW 
BEGIN
    SET NEW.update_time = CURRENT_TIMESTAMP;
END$$

CREATE TRIGGER tr_oil_gun_update 
BEFORE UPDATE ON oil_gun
FOR EACH ROW 
BEGIN
    SET NEW.update_time = CURRENT_TIMESTAMP;
END$$
DELIMITER ;
```

#### 3.2.2 变更记录自动生成触发器

```sql
-- 油站变更记录触发器
DELIMITER $$
CREATE TRIGGER tr_station_change_log 
AFTER UPDATE ON gas_station
FOR EACH ROW 
BEGIN
    INSERT INTO equipment_change_record (
        id, record_code, object_id, object_type, object_code, object_name,
        station_id, station_name, operation_type, operation_description,
        operator_id, operator_name, operate_time, approval_status
    ) VALUES (
        UUID(), CONCAT('CHG', DATE_FORMAT(NOW(), '%Y%m%d'), LPAD(LAST_INSERT_ID(), 6, '0')),
        NEW.id, '油站', NEW.station_code, NEW.station_name,
        NEW.id, NEW.station_name, '编辑', '油站信息修改',
        NEW.updated_by, '', NOW(), '待审批'
    );
END$$
DELIMITER ;
```

---

## 4. 数据初始化

### 4.1 基础数据初始化

#### 4.1.1 油品类型数据

```sql
INSERT INTO oil_type_ref (oil_type_code, oil_type_name, default_density, status) VALUES
('92', '92#汽油', 0.745, '有效'),
('95', '95#汽油', 0.752, '有效'),
('98', '98#汽油', 0.759, '有效'),
('0', '0#柴油', 0.835, '有效'),
('-10', '-10#柴油', 0.845, '有效'),
('UF', '尿素', 1.087, '有效');
```

### 4.2 示例数据

#### 4.2.1 示例油站数据

```sql
INSERT INTO gas_station (
    id, station_code, station_name, station_type, legal_entity,
    branch_id, branch_name, service_area_id, service_area_name,
    address, coordinates, contact_person, contact_phone, status,
    created_by, updated_by
) VALUES (
    'ST001', '01010001', '南昌高速服务区加油站', '高速站', '高速石化',
    'BR001', '赣中分公司', 'SA001', '南昌服务区',
    '江西省南昌市高速公路南昌服务区', '115.892151,28.676493',
    '张经理', '13800138001', '正常',
    'USER001', 'USER001'
);
```

---

## 5. 性能优化建议

### 5.1 索引优化

**复合索引建议：**
```sql
-- 油站查询优化
CREATE INDEX idx_station_branch_status ON gas_station(branch_id, status);
CREATE INDEX idx_station_type_status ON gas_station(station_type, status);

-- 油罐查询优化  
CREATE INDEX idx_tank_station_oil_type ON oil_tank(station_id, oil_type);
CREATE INDEX idx_tank_status_station ON oil_tank(status, station_id);

-- 油枪查询优化
CREATE INDEX idx_gun_station_status ON oil_gun(station_id, status);
CREATE INDEX idx_gun_tank_status ON oil_gun(tank_id, status);

-- 变更记录查询优化
CREATE INDEX idx_record_time_status ON equipment_change_record(operate_time, approval_status);
CREATE INDEX idx_record_station_type ON equipment_change_record(station_id, object_type);
```

### 5.2 分区建议

对于变更记录表，建议按时间进行分区：

```sql
-- 按月分区变更记录表
ALTER TABLE equipment_change_record 
PARTITION BY RANGE (YEAR(operate_time) * 100 + MONTH(operate_time)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    PARTITION p202503 VALUES LESS THAN (202504),
    -- 继续添加后续分区
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 5.3 查询优化

**常用查询语句优化：**

```sql
-- 优化油站列表查询
SELECT s.*, b.branch_name 
FROM gas_station s 
INNER JOIN organization b ON s.branch_id = b.id 
WHERE s.status = '正常' AND s.branch_id IN ('BR001', 'BR002')
ORDER BY s.order_number, s.create_time DESC;

-- 优化设备统计查询
SELECT 
    s.station_name,
    COUNT(t.id) as tank_count,
    COUNT(g.id) as gun_count
FROM gas_station s
LEFT JOIN oil_tank t ON s.id = t.station_id AND t.status = '正常'
LEFT JOIN oil_gun g ON s.id = g.station_id AND g.status = '正常'
WHERE s.status = '正常'
GROUP BY s.id, s.station_name;
```

---

## 6. 数据安全和备份

### 6.1 数据安全策略

- **敏感数据加密：** 联系电话等个人信息采用AES加密存储
- **数据访问控制：** 基于角色的数据访问权限控制
- **操作日志记录：** 所有数据变更操作完整记录
- **数据完整性校验：** 定期进行数据一致性检查

### 6.2 备份策略

- **全量备份：** 每日凌晨执行全量数据库备份
- **增量备份：** 每小时执行增量备份
- **日志备份：** 实时备份事务日志
- **异地备份：** 备份文件异地存储，保证数据安全

---

**文档状态：** 草稿  
**下一步行动：** DBA审核数据库设计方案 